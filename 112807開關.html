<!DOCTYPE html>
<html lang="zh-Hant">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v7.1</title>

<style>
/* ===== åŸºæœ¬é¡è‰² ===== */
:root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}

/* ===== åŸºç¤ Layout ===== */
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}

header{display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;align-items:stretch;}

.title{background:#e8f7ee;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;padding:12px;}
.title h1{margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;}

.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;font-weight:700;}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}

.top-panels{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap);}
.panel{background:#fff;border:4px solid var(--panel);border-radius:var(--radius);padding:12px;}
.panel h2{margin:0 0 8px 0;font-size:28px}

.weather-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.weather-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;}
.weather-cell img{width:36px;height:36px;}

.env-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.env-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;color:var(--num);}
.env-cell img{width:50px;height:50px;}
.env-cell .value{font-size:36px;font-weight:800}

.table-wrap{margin-top:var(--gap);background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px}
.table-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
.table-title h3{margin:0;font-size:26px}

.btn{
  background:var(--panel);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:10px 0;
  width:130px;
  font-size:20px;
  font-weight:800;
  cursor:pointer;
}
.btn:active{transform:translateY(1px);}
.depth-btn.active{background:var(--ok);}

/* é€šçŸ¥é–‹é—œæŒ‰éˆ• */
#btnToggleNotify{
  width:160px;
  background:#666;
}
#btnToggleNotify.on{
  background:#16a34a !important;
}

#notifyStatus{
  font-size:18px;
  font-weight:800;
  color:#0b2d2a;
  margin-left:10px;
}

table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{font-size:18px;color:#334155;text-align:center}
tbody td,thead th{padding:10px 8px}
tbody tr{background:var(--tile);}
tbody tr td{font-size:22px;text-align:center;font-weight:700;color:var(--num)}
tbody tr td:first-child{font-weight:800;color:#1f2937}

.footer-line{color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;}

.val-ok { color:#0f9d58 !important; font-weight:900; }
.val-warn { color:#f4b400 !important; font-weight:900; }
.val-bad { color:#db4437 !important; font-weight:900; }

</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="datebox" id="dateBox">--</div>
  <div class="title"><h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1><small>Real-time Dashboard v7.1</small></div>
  <div class="clock"><div id="mainClock">00:00:00</div></div>
</header>

<!-- ============================================= -->
<!--                å¤©æ°£å€å¡Š                       -->
<!-- ============================================= -->
<div class="top-panels">
  <section class="panel">
    <h2>å—æŠ• åé–“é„‰å¤©æ°£ç‹€æ³</h2>
    <div class="weather-grid">
      <div class="weather-cell"><img id="weatherIcon" src=""><span>å¤©æ°£ï¼š<span id="weatherDesc">â€”</span></span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><span>æ°£æº«ï¼š<span id="weatherTemp">â€”</span> Â°C</span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/color/48/humidity.png"><span>æ¿•åº¦ï¼š<span id="weatherHumi">â€”</span> %</span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/umbrella-with-rain-drops.png"><span>é™é›¨é‡ï¼š<span id="rainfall">â€”</span> mm</span></div>
    </div>
  </section>

  <section class="panel">
    <h2>èŒ¶åœ’æº«æº¼åº¦æ„Ÿæ¸¬å™¨</h2>
    <div class="env-grid">
      <div class="env-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><div><span>æº«åº¦</span><br><span class="value" id="envTemp">â€”</span></div></div>
      <div class="env-cell"><img src="https://img.icons8.com/color/48/humidity.png"><div><span>æ¿•åº¦</span><br><span class="value" id="envHumi">â€”</span></div></div>
    </div>
  </section>
</div>

<!-- ============================================= -->
<!--               åœŸå£¤æ„Ÿæ¸¬æ•¸æ“š                    -->
<!-- ============================================= -->
<section class="table-wrap">
  <div class="table-title">
    <h3>å„ç«™åœŸå£¤æ•¸æ“š</h3>

    <div class="depth-buttons"> 
      <button class="btn depth-btn active" data-depth="Surface">è¡¨é¢å±¤</button>
      <button class="btn depth-btn" data-depth="15cm">15 cm å±¤</button>
      <button class="btn depth-btn" data-depth="25cm">25 cm å±¤</button>
      <button class="btn" id="btnFullscreen">å…¨è¢å¹•</button>

      <!-- ğŸ”” é€šçŸ¥é–‹é—œ -->
      <button class="btn" id="btnToggleNotify">é€šçŸ¥ ON/OFF</button>
      <span id="notifyStatus">é€šçŸ¥ï¼šå·²é–‹å•Ÿ</span>

      <button class="btn" id="btnNotify">ğŸ”” é€šçŸ¥æ¸¬è©¦</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>é …ç›®</th><th>æº«åº¦ (Â°C)</th><th>å«æ°´ç‡ (%)</th>
        <th>æ°® (N)</th><th>ç£· (P)</th><th>é‰€ (K)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer-line" id="footerInfo">
    æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼šâ€”ã€€ï½œã€€æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼šâ€”ã€€ï½œã€€ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼šâ€”
  </div>
</section>

<!-- ============================================= -->
<!--                 Script Start                  -->
<!-- ============================================= -->
<script>

/* ============================================================
   ğŸŒŸ é€šçŸ¥é–‹é—œï¼ˆLocalStorageï¼‰
   ============================================================ */

let NOTIFY_ENABLED = true;

// è¼‰å…¥ä¹‹å‰ä½¿ç”¨è€…çš„è¨­å®š
if (localStorage.getItem("tea_notify") === "off") {
  NOTIFY_ENABLED = false;
}

// æ›´æ–° UI
function updateNotifyUI(){
  const btn = document.getElementById("btnToggleNotify");
  const st  = document.getElementById("notifyStatus");

  if(NOTIFY_ENABLED){
    btn.classList.add("on");
    st.textContent = "é€šçŸ¥ï¼šå·²é–‹å•Ÿ";
  }else{
    btn.classList.remove("on");
    st.textContent = "é€šçŸ¥ï¼šå·²é—œé–‰";
  }
}
updateNotifyUI();

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("btnToggleNotify").onclick = ()=>{
  NOTIFY_ENABLED = !NOTIFY_ENABLED;
  localStorage.setItem("tea_notify", NOTIFY_ENABLED ? "on" : "off");
  updateNotifyUI();
};


/* ============================================================
   ğŸŒŸ AI é€šçŸ¥æ•´åˆï¼ˆæœƒå…ˆæª¢æŸ¥é–‹é—œï¼‰
   ============================================================ */

async function sendNotification(title, body) {
  if (!NOTIFY_ENABLED) return;

  if (Notification.permission !== "granted") {
    const perm = await Notification.requestPermission();
    if (perm !== "granted") return;
  }
  new Notification(title, {
    body,
    icon:"https://img.icons8.com/color/96/tea.png"
  });
}

function sendLineNotify(title, message) {
  if (!NOTIFY_ENABLED) return;

  fetch("https://script.google.com/macros/s/AKfycbyHvIZqDqpG4vXJSYxzx2F7KhmrVzLFWB3R1Fzx7VYG080RPTtaUdqJgupV4ZPPyM3_2g/exec", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
  });
}

function alertTea(title, message){
  if (!NOTIFY_ENABLED) return;
  sendNotification(title, message);
  sendLineNotify(title, message);
  console.log("[AI é€šçŸ¥] ", title, message);
}


/* ä»¥ä¸‹å…¨éƒ¨ä¿æŒä½ çš„ v7.1 åŸæ¨£ï¼ŒåªåŠ é€šçŸ¥é–‹é—œã€‚*/
/* ============================================================ */

const ALERT_RULES = {
  moisture:{ low:20 },
  temperature:{ high:35, low:10 },
  npk:{ min:1, low:20 },
  rain:{ min:0.1 },
  offline:{ limitMinutes:10 }
};

const CONFIG = {
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};

function pad(n){return n<10?'0'+n:n}
function nowStr(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
function dateStr(){const d=new Date();const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰` }
function roundInt(x){if(x==null||x==='')return'â€”';const n=Number(x);return isFinite(n)?Math.round(n):String(x);}

let notified = {
  moisture: {},
  npk: {},
  temp: {},
  weather: false,
  offline: false
};

/* å«æ°´ç‡ */
function checkMoisture(station, v){
  if(v < ALERT_RULES.moisture.low && !notified.moisture[station]){
    alertTea("åœŸå£¤å«æ°´ç‡åä½", `ç¬¬ ${station} ç«™åƒ… ${v}%`);
    notified.moisture[station] = true;
  }
}

/* åœŸå£¤æº«åº¦ */
function checkSoilTemp(station, v){
  const {high, low} = ALERT_RULES.temperature;

  if(v > high && !notified.temp[station+"_high"]){
    alertTea("åœŸå£¤æº«åº¦éé«˜", `ç¬¬ ${station} ç«™ ${v}Â°C`);
    notified.temp[station+"_high"] = true;
  }

  if(v < low && !notified.temp[station+"_low"]){
    alertTea("åœŸå£¤éå†·", `ç¬¬ ${station} ç«™åƒ… ${v}Â°C`);
    notified.temp[station+"_low"] = true;
  }
}

/* NPK */
function checkNPK(station, n, p, k) {
  const { min, low } = ALERT_RULES.npk;

  const checkOne = (name, v) => {
    const keyMin = `${station}_${name}_min`;
    const keyLow = `${station}_${name}_low`;

    if (v === "â€”" || v === null || isNaN(v)) return;

    if (v <= min && !notified.npk[keyMin]) {
      alertTea(`${name} åš´é‡åä½`, `ç¬¬ ${station} ç«™ ${name}=${v}`);
      notified.npk[keyMin] = true;
      return;
    }

    if (v < low && !notified.npk[keyLow]) {
      alertTea(`${name} æ•¸å€¼åä½`, `ç¬¬ ${station} ç«™ ${name}=${v}`);
      notified.npk[keyLow] = true;
    }
  };

  checkOne("N", n);
  checkOne("P", p);
  checkOne("K", k);
}

function checkRain(value){
  if(value >= ALERT_RULES.rain.min && !notified.weather){
    alertTea("ğŸŒ§ é–‹å§‹ä¸‹é›¨", `åé–“é™é›¨é‡ï¼š${value} mm`);
    notified.weather = true;
  }
}

let lastUpdateTime = Date.now();
function checkOffline(){
  const limitMs = ALERT_RULES.offline.limitMinutes * 60 * 1000;

  if(!notified.offline && Date.now() - lastUpdateTime > limitMs){
    alertTea("âš  æ„Ÿæ¸¬å™¨æ‰ç·š",
      `å·² ${ALERT_RULES.offline.limitMinutes} åˆ†é˜ç„¡æ›´æ–°`);
    notified.offline = true;
  }
}
setInterval(checkOffline, 10000);

function colorClass(type, value){
  if(value === "â€”" || value === "" || value == null) return "";
  value = Number(value);

  switch(type){
    case "temp":
      if(value < 10) return "val-warn";
      if(value < 28) return "val-ok";
      if(value < 35) return "val-warn";
      return "val-bad";

    case "moist":
      if(value < 20) return "val-bad";
      if(value < 35) return "val-warn";
      if(value < 70) return "val-ok";
      return "val-warn";

    case "n":
    case "p":
    case "k":
      if(value === 0) return "val-bad";
      if(value < 20) return "val-warn";
      return "val-ok";

    default: return "";
  }
}

let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes * 60;

function updateFooter(){
  const m=Math.floor(remainingSec/60), s=pad(remainingSec%60);
  footerInfo.textContent =
    `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime} ï½œ æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime} ï½œ ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now());
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(','));
  return {cols:lines[0],rows:lines.slice(1)};
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--)
    if(rows[i].some(v=>v!=="")) return rows[i];
  return null;
}

async function refreshSheet(depth="Surface"){
  try{
    const {cols, rows} = await fetchCSV();
    const last = getLastValid(rows);
    if(!last) return;

    const idx={};
    cols.forEach((c,i)=>idx[c.toLowerCase()] = i);

    genTime = last[idx["time"]] || "â€”";
    lastUpdateTime = Date.now();
    updateFooter();

    envTemp.textContent = roundInt(last[idx["teagarden_air_temp"]]);
    envHumi.textContent = roundInt(last[idx["teagarden_air_humidity"]]);

    tbody.innerHTML="";

    for(let s=1;s<=CONFIG.stationCount;s++){
      const p=`station${s}_${depth.toLowerCase()}`;

      const soilTemp = roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist = roundInt(last[idx[`${p}_soilmoisture`]]);
      const n = roundInt(last[idx[`${p}_nitrogen`]]);
      const p2 = roundInt(last[idx[`${p}_phosphorus`]]);
      const k = roundInt(last[idx[`${p}_potassium`]]);

      /* AI åµæ¸¬ */
      checkMoisture(s, soilMoist);
      checkSoilTemp(s, soilTemp);
      checkNPK(s, n, p2, k);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>ç¬¬${s}ç«™</td>
        <td class="${colorClass('temp', soilTemp)}">${soilTemp}</td>
        <td class="${colorClass('moist', soilMoist)}">${soilMoist}</td>
        <td class="${colorClass('n', n)}">${n}</td>
        <td class="${colorClass('p', p2)}">${p2}</td>
        <td class="${colorClass('k', k)}">${k}</td>
      `;
      tbody.appendChild(tr);
    }

  }catch(e){
    console.warn("CSV éŒ¯èª¤ï¼š",e);
  }
}

async function refreshWeather(){
  try{
    const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;
    const res=await fetch(url);
    const js=await res.json();
    const st=js.records?.Station?.[0];
    const w=st?.WeatherElement||{};

    weatherDesc.textContent = w.Weather || "â€”";
    weatherTemp.textContent = roundInt(w.AirTemperature);
    weatherHumi.textContent = roundInt(w.RelativeHumidity);
    rainfall.textContent = roundInt(w.Now?.Precipitation);

    checkRain(Number(w.Now?.Precipitation || 0));

    weatherIcon.src =
      w.Weather?.includes("é›¨")
      ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
      : "https://img.icons8.com/emoji/48/sun-emoji.png";

    weatherTime = st?.ObsTime?.DateTime?.replace("T"," ").slice(0,19) || "â€”";
    updateFooter();

  }catch(e){
    console.warn("æ°£è±¡éŒ¯èª¤:", e);
  }
}

/* ============================================================
   8. UI è¡Œç‚º + è‡ªå‹•åˆ·æ–°
   ============================================================ */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    refreshSheet(btn.dataset.depth);
  });
});

btnFullscreen.onclick=()=>document.documentElement.requestFullscreen?.();
btnNotify.onclick=()=>alertTea("ğŸ”” æ¸¬è©¦é€šçŸ¥","é€™æ˜¯ä¸€å‰‡æ¸¬è©¦ï¼ˆå« LINE + ç€è¦½å™¨ï¼‰");

(function tick(){
  mainClock.textContent = nowStr();
  dateBox.textContent = dateStr();
  setTimeout(tick,250);
})();

setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0){
    location.replace(location.href.split("?")[0]+"?t="+Date.now());
    return;
  }
  updateFooter();
},1000);

refreshSheet();
refreshWeather();

</script>

</body>
</html>
