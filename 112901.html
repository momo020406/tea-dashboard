<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v7.4</title>

<style>
/* ===== é¡è‰² ===== */
:root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}

/* ===== åŸºç¤ ===== */
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}

/* ===== Header ===== */
header{
  display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;
  align-items:stretch;
}
.title{
  background:#e8f7ee;border:4px solid var(--panel);
  border-radius:var(--radius);
  display:flex;align-items:center;
  justify-content:center;flex-direction:column;padding:12px;
}
.title h1{margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;}
.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;font-weight:700;
}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}

/* ===== å¤©æ°£ ===== */
.top-panels{
  display:grid;grid-template-columns:1fr 1fr;
  gap:var(--gap);margin-top:var(--gap);
}
.panel{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:12px;
}
.panel h2{margin:0 0 8px 0;font-size:28px}

.weather-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:10px 12px;background:var(--tile);
  border-radius:14px;padding:12px;
}
.weather-cell{
  display:flex;align-items:center;gap:10px;
  font-size:22px;font-weight:700;
}
.weather-cell img{width:36px;height:36px;}

/* ===== æº«æ¿•åº¦ ===== */
.env-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:12px;background:var(--tile);
  border-radius:14px;padding:12px;
}
.env-cell{
  display:flex;align-items:center;gap:10px;
  font-size:22px;font-weight:700;color:var(--num);
}
.env-cell img{width:50px;height:50px;}
.env-cell .value{font-size:36px;font-weight:800}

/* ===== è¡¨æ ¼ ===== */
.table-wrap{
  margin-top:var(--gap);
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px;
}
.table-title{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;margin-bottom:10px;gap:10px;
}
.table-title h3{margin:0;font-size:26px;}

.btn{
  background:var(--panel);color:#fff;border:none;
  border-radius:999px;padding:10px 0;width:130px;
  font-size:20px;font-weight:800;cursor:pointer;
}
.btn:active{transform:translateY(1px);}
.depth-btn.active{background:var(--ok);}

/* é€šçŸ¥ */
#btnToggleNotify{width:150px;background:#777;}
#btnToggleNotify.on{background:#16a34a !important;}
#notifyStatus{
  font-size:17px;font-weight:800;color:#0b2d2a;margin-left:8px;
}

/* è¡¨æ ¼æ ¼å¼ */
table{
  width:100%;border-collapse:separate;border-spacing:0 10px;
}
thead th{text-align:center;font-size:18px;color:#334155;}
tbody td{
  text-align:center;font-size:22px;font-weight:700;
  padding:10px 8px;color:var(--num);
}
tbody tr{background:var(--tile);}
tbody tr td:first-child{color:#1f2937;font-weight:800;}

.footer-line{
  color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;
}

/* è‰²å½© */
.val-ok   { color:#0f9d58 !important;font-weight:900; }
.val-warn { color:#f4b400 !important;font-weight:900; }
.val-bad  { color:#db4437 !important;font-weight:900; }

/* ===== df-messenger é®®è±”äº®è‰² ===== */
df-messenger {
  --df-messenger-bot-message: #00C853;
  --df-messenger-button-titlebar-color: #00E676;
  --df-messenger-chat-background-color: #E2FBE2;
  --df-messenger-font-color: #000;
  --df-messenger-user-message: #245953;
}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="datebox" id="dateBox">--</div>
  <div class="title">
    <h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1>
    <small>Real-time Dashboard v7.4</small>
  </div>
  <div class="clock"><div id="mainClock">00:00:00</div></div>
</header>

<!-- ======================= SCRIPT START ======================= -->
<script>
window.addEventListener("DOMContentLoaded",()=>{

/* ============================================================
   1. é€šçŸ¥é–‹é—œ
   ============================================================ */
let NOTIFY_ENABLED = true;
if(localStorage.getItem("tea_notify")==="off"){ NOTIFY_ENABLED=false; }

function updateNotifyUI(){
  const b=document.getElementById("btnToggleNotify");
  const s=document.getElementById("notifyStatus");
  if(NOTIFY_ENABLED){
    b.classList.add("on"); s.textContent="é€šçŸ¥ï¼šå·²é–‹å•Ÿ";
  } else {
    b.classList.remove("on"); s.textContent="é€šçŸ¥ï¼šå·²é—œé–‰";
  }
}
updateNotifyUI();

document.getElementById("btnToggleNotify").onclick = () =>{
  NOTIFY_ENABLED=!NOTIFY_ENABLED;
  localStorage.setItem("tea_notify", NOTIFY_ENABLED?"on":"off");
  updateNotifyUI();
};

/* ============================================================
   2. Web + LINE é€šçŸ¥
   ============================================================ */
async function sendNotification(title,body){
  if(!NOTIFY_ENABLED) return;

  if(Notification.permission!=="granted"){
    const p=await Notification.requestPermission();
    if(p!=="granted") return;
  }

  new Notification(title,{
    body,
    icon:"https://img.icons8.com/color/96/tea.png"
  });
}

function sendLineNotify(title,message){
  if(!NOTIFY_ENABLED) return;
  fetch("https://script.google.com/macros/s/AKfycbyHvIZqDqpG4vXJSYxzx2F7KhmrVzLFWB3R1Fzx7VYG080RPTtaUdqJgupV4ZPPyM3_2g/exec",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
  });
}

/* ============================================================
   â­â­â­ 3. AI åˆ†æé€šçŸ¥ï¼ˆæº«åº¦ï¼‹å«æ°´ç‡ï¼‹NPKï¼‰ B ç‰ˆ
   ============================================================ */

/* å››ç«™è³‡æ–™å®¹å™¨ */
let stationAlert = {
  "ç¬¬1ç«™": [], "ç¬¬2ç«™": [],
  "ç¬¬3ç«™": [], "ç¬¬4ç«™": []
};

/* è¨ºæ–·ç­‰ç´š */
function level(type, value){
  if(type==="temp"){
    if(value>=35) return {lv:"ğŸ”¥ éé«˜", adv:"é®é™°ã€ç‘æ°´é™æº«"};
    if(value<=10) return {lv:"â„ éä½", adv:"åŠ å¼·ä¿æº«"};
    return {lv:"ğŸŸ¢ æ­£å¸¸"};
  }
  if(type==="moist"){
    if(value<20) return {lv:"ğŸ’§ åä½", adv:"ç«‹å³çŒæº‰"};
    if(value>80) return {lv:"ğŸŒŠ éæ¿•", adv:"æ”¹å–„æ’æ°´"};
    return {lv:"ğŸŸ¢ æ­£å¸¸"};
  }
  if(type==="N"){
    if(value<10) return {lv:"ğŸ”´ åš´é‡åä½", adv:"è£œå……æ°®è‚¥ï¼ˆå°¿ç´ ï¼‰"};
    if(value<20) return {lv:"ğŸŸ  åä½", adv:"è£œå……æ°®è‚¥"};
    return {lv:"ğŸŸ¢ æ­£å¸¸"};
  }
  if(type==="P"){
    if(value<6) return {lv:"ğŸ”´ åš´é‡åä½", adv:"è£œå……ç£·è‚¥ï¼ˆéç£·é…¸éˆ£ï¼‰"};
    if(value<15) return {lv:"ğŸŸ  åä½", adv:"è£œå……ç£·è‚¥"};
    return {lv:"ğŸŸ¢ æ­£å¸¸"};
  }
  if(type==="K"){
    if(value<8) return {lv:"ğŸ”´ åš´é‡åä½", adv:"è£œå……é‰€è‚¥ï¼ˆæ°¯åŒ–é‰€/ç¡«é…¸é‰€ï¼‰"};
    if(value<20) return {lv:"ğŸŸ  åä½", adv:"è£œå……é‰€è‚¥"};
    return {lv:"ğŸŸ¢ æ­£å¸¸"};
  }
  return {lv:"ğŸŸ¢ æ­£å¸¸"};
}

/* çµ„è£ç«™é»è³‡æ–™ */
function addAlert(station, typeLabel, typeKey, value){
  const diag = level(typeKey, value);
  if(diag.lv==="ğŸŸ¢ æ­£å¸¸") return;

  stationAlert[station].push({
    label:typeLabel,
    value:value,
    level:diag.lv,
    advice:diag.adv
  });
}

/* â­ çµ„åˆå®Œæ•´ AI å ±å‘Šï¼ˆçµ¦ LINEï¼‰ */
function buildAIMessage(){
  let msg = "ğŸ“¡ ç‘æˆæ™ºæ…§èŒ¶åœ’ AI é¤Šåˆ†èˆ‡åœŸå£¤è¨ºæ–·å ±å‘Š\nï¼ˆä¾ç«™é»æ’åºï¼‰\n\n";

  for(let i=1;i<=4;i++){
    const st = `ç¬¬${i}ç«™`;
    msg += `ã€${st}ã€‘\n`;

    const arr=stationAlert[st];
    if(arr.length===0){
      msg += "ğŸŸ¢ å…¨éƒ¨æ­£å¸¸\n\n";
      continue;
    }

    arr.forEach(item=>{
      msg += `${item.label}ï¼š${item.value} ${item.level}\n`;
      if(item.advice) msg += `â†’ å»ºè­°ï¼š${item.advice}\n`;
    });
    msg += "\n";
  }

  return msg;
}

/* â­ ç™¼é€ä¸€æ¬¡ç¸½å ±å‘Š */
function sendAIAlert(){
  const msg = buildAIMessage();

  const allOK = Object.values(stationAlert)
    .every(list => list.length===0);

  if(allOK) return;

  sendNotification("ğŸŒ± AI åœŸå£¤è¨ºæ–·é€šçŸ¥", msg);
  sendLineNotify("ğŸŒ± AI åœŸå£¤è¨ºæ–·é€šçŸ¥", msg);

  stationAlert = {
    "ç¬¬1ç«™": [], "ç¬¬2ç«™": [],
    "ç¬¬3ç«™": [], "ç¬¬4ç«™": []
  };
}
/* ============================================================
   4. åƒæ•¸è¨­å®š
   ============================================================ */
const CONFIG={
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};

/* ============================================================
   5. æ™‚é˜ã€æ™‚é–“å·¥å…·
   ============================================================ */
function pad(n){return n<10?"0"+n:n}
function nowStr(){
  const d=new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function dateStr(){
  const d=new Date();
  const w=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()];
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰`;
}
function roundInt(x){
  if(x==null||x==="") return "â€”";
  const n=Number(x);
  return isFinite(n)?Math.round(n):String(x);
}

/* ============================================================
   6. CSV è®€å–
   ============================================================ */
async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now());
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(','));
  return {cols:lines[0],rows:lines.slice(1)};
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--)
    if(rows[i].some(v=>v!=="")) return rows[i];
  return null;
}

/* ============================================================
   7. è¡¨æ ¼æ¸²æŸ“ + AI åˆ†æä¸²æ¥
   ============================================================ */
let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes*60;
let lastUpdateTime = Date.now();

function updateFooter(){
  const m=Math.floor(remainingSec/60);
  const s=pad(remainingSec%60);
  document.getElementById("footerInfo").textContent=
    `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime} ï½œ æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime} ï½œ ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

/* ===== é¡è‰²è¦å‰‡ ===== */
function colorClass(type,v){
  if(v==="â€”"||v==null||v==="") return "";
  v=Number(v);
  switch(type){
    case "temp":
      if(v<10) return "val-warn";
      if(v<28) return "val-ok";
      if(v<35) return "val-warn";
      return "val-bad";
    case "moist":
      if(v<20) return "val-bad";
      if(v<35) return "val-warn";
      if(v<70) return "val-ok";
      return "val-warn";
    case "n":
    case "p":
    case "k":
      if(v===0) return "val-bad";
      if(v<20) return "val-warn";
      return "val-ok";
  }
  return "";
}

async function refreshSheet(depth="Surface"){
  try{
    const {cols,rows}=await fetchCSV();
    const last=getLastValid(rows);
    if(!last) return;

    const idx={};
    cols.forEach((c,i)=>idx[c.toLowerCase()]=i);

    genTime=last[idx["time"]]||"â€”";
    lastUpdateTime=Date.now();
    updateFooter();

    document.getElementById("envTemp").textContent =
      roundInt(last[idx["teagarden_air_temp"]]);
    document.getElementById("envHumi").textContent =
      roundInt(last[idx["teagarden_air_humidity"]]);

    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    /* é‡ç½® AI æš«å­˜è³‡æ–™ */
    stationAlert={
      "ç¬¬1ç«™":[],"ç¬¬2ç«™":[],
      "ç¬¬3ç«™":[],"ç¬¬4ç«™":[]
    };

    for(let s=1;s<=CONFIG.stationCount;s++){
      const st=`ç¬¬${s}ç«™`;
      const p=`station${s}_${depth.toLowerCase()}`;

      const soilTemp=roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist=roundInt(last[idx[`${p}_soilmoisture`]]);
      const n=roundInt(last[idx[`${p}_nitrogen`]]);
      const p2=roundInt(last[idx[`${p}_phosphorus`]]);
      const k=roundInt(last[idx[`${p}_potassium`]]);

      /* â­ åŠ åˆ° AI åˆ†æ */
      addAlert(st,"åœŸå£¤æº«åº¦","temp",soilTemp);
      addAlert(st,"å«æ°´ç‡","moist",soilMoist);
      addAlert(st,"æ°® (N)","N",n);
      addAlert(st,"ç£· (P)","P",p2);
      addAlert(st,"é‰€ (K)","K",k);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${st}</td>
        <td class="${colorClass('temp',soilTemp)}">${soilTemp}</td>
        <td class="${colorClass('moist',soilMoist)}">${soilMoist}</td>
        <td class="${colorClass('n',n)}">${n}</td>
        <td class="${colorClass('p',p2)}">${p2}</td>
        <td class="${colorClass('k',k)}">${k}</td>
      `;
      tbody.appendChild(tr);
    }

    /* â­ æ‰€æœ‰è³‡æ–™è¼‰å®Œ â†’ ç™¼é€ AI LINE è¨ºæ–· */
    sendAIAlert();

  }catch(e){
    console.warn("CSV éŒ¯èª¤:",e);
  }
}

/* ============================================================
   8. å¤©æ°£è³‡æ–™
   ============================================================ */
async function refreshWeather(){
  try{
    const url=
      `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?`+
      `Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;

    const res=await fetch(url);
    const js=await res.json();
    const st=js.records?.Station?.[0];
    const w=st?.WeatherElement||{};

    document.getElementById("weatherDesc").textContent = w.Weather || "â€”";
    document.getElementById("weatherTemp").textContent = roundInt(w.AirTemperature);
    document.getElementById("weatherHumi").textContent = roundInt(w.RelativeHumidity);
    document.getElementById("rainfall").textContent = roundInt(w.Now?.Precipitation);

    document.getElementById("weatherIcon").src =
      w.Weather?.includes("é›¨")
        ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
        : "https://img.icons8.com/emoji/48/sun-emoji.png";

    weatherTime = st?.ObsTime?.DateTime?.replace("T"," ").slice(0,19) || "â€”";
    updateFooter();

  }catch(e){
    console.warn("æ°£è±¡éŒ¯èª¤:",e);
  }
}

/* ============================================================
   9. UI æ“ä½œ
   ============================================================ */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    refreshSheet(btn.dataset.depth);
  });
});

document.getElementById("btnFullscreen").onclick=
  ()=>document.documentElement.requestFullscreen?.();

document.getElementById("btnNotify").onclick=
  ()=>sendLineNotify("ğŸ”” æ¸¬è©¦é€šçŸ¥","é€™æ˜¯ LINE é€šçŸ¥æ¸¬è©¦");

/* ============================================================
   10. æ™‚é˜ + è‡ªå‹•åˆ·æ–°
   ============================================================ */
(function tickClock(){
  document.getElementById("mainClock").textContent=nowStr();
  document.getElementById("dateBox").textContent=dateStr();
  setTimeout(tickClock,250);
})();

setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0){
    location.reload();
    return;
  }
  updateFooter();
},1000);

/* ============================================================
   11. åˆå§‹åŒ–
   ============================================================ */
refreshSheet();
refreshWeather();

}); // DOMContentLoaded END
</script>

<!-- ============================================================
     â­ df-messenger è‡ªå‹•ä¿®å¾©ï¼ˆç¢ºä¿ä¸€å®šæœƒå‡ºç¾ï¼‰
============================================================ -->
<script>
function ensureChatbotLoaded() {
  const chatbot = document.querySelector("df-messenger");

  if (chatbot && !chatbot.shadowRoot) {
    console.warn("df-messenger æœªåˆå§‹åŒ– â†’ è‡ªå‹•ä¿®å¾©");

    const attr = {
      intent: chatbot.getAttribute("intent"),
      "chat-title": chatbot.getAttribute("chat-title"),
      "agent-id": chatbot.getAttribute("agent-id"),
      "language-code": chatbot.getAttribute("language-code")
    };

    chatbot.remove();

    const newBot = document.createElement("df-messenger");
    for (const k in attr) newBot.setAttribute(k, attr[k]);
    document.body.appendChild(newBot);
  }
}

window.addEventListener("dfMessengerLoaded", () => {
  console.log("df-messenger æˆåŠŸè¼‰å…¥!");
});

setTimeout(ensureChatbotLoaded, 1200);

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    setTimeout(ensureChatbotLoaded, 300);
  }
});
</script>

<!-- ===== Dialogflow Messenger ===== -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
<df-messenger
  intent="WELCOME"
  chat-title="ç‘æˆèŒ¶åœ’æ™ºæ…§åŠ©æ‰‹"
  agent-id="8b30913c-be1a-4cd9-9309-136c81726d04"
  language-code="zh-tw">
</df-messenger>

</body>
</html>
