<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v7.2</title>

<style>
/* ===== åŸºæœ¬é¡è‰² ===== */
:root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}

/* ===== åŸºç¤ Layout ===== */
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}

header{display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;align-items:stretch;}

.title{background:#e8f7ee;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;padding:12px;}
.title h1{margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;}

.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;font-weight:700;}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}

/* ===== å¤©æ°£ + æº«æ¿•åº¦ ===== */
.top-panels{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap);}
.panel{background:#fff;border:4px solid var(--panel);border-radius:var(--radius);padding:12px;}
.panel h2{margin:0 0 8px 0;font-size:28px}

.weather-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.weather-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;}
.weather-cell img{width:36px;height:36px;}

.env-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.env-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;color:var(--num);}
.env-cell img{width:50px;height:50px;}
.env-cell .value{font-size:36px;font-weight:800}

/* ===== åœŸå£¤æ•¸æ“šè¡¨æ ¼ ===== */
.table-wrap{margin-top:var(--gap);background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px}
.table-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
.table-title h3{margin:0;font-size:26px}

.btn{
  background:var(--panel);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:10px 0;
  width:130px;
  font-size:20px;
  font-weight:800;
  cursor:pointer;
}
.btn:active{transform:translateY(1px);}
.depth-btn.active{background:var(--ok);}

/* ===== é€šçŸ¥ ON/OFF ===== */
#btnToggleNotify{
  width:150px;
  background:#777;
}
#btnToggleNotify.on{
  background:#16a34a !important;
}

#notifyStatus{
  font-size:17px;
  font-weight:800;
  color:#0b2d2a;
  margin-left:8px;
}

/* ===== è¡¨æ ¼ ===== */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{font-size:18px;color:#334155;text-align:center}
tbody td,thead th{padding:10px 8px}
tbody tr{background:var(--tile);}
tbody tr td{font-size:22px;text-align:center;font-weight:700;color:var(--num)}
tbody tr td:first-child{font-weight:800;color:#1f2937}

.footer-line{
  color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;
}

/* æ•¸å€¼é¡è‰² */
.val-ok { color:#0f9d58 !important; font-weight:900; }
.val-warn { color:#f4b400 !important; font-weight:900; }
.val-bad { color:#db4437 !important; font-weight:900; }
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="datebox" id="dateBox">--</div>
  <div class="title"><h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1><small>Real-time Dashboard v7.2</small></div>
  <div class="clock"><div id="mainClock">00:00:00</div></div>
</header>

<div class="top-panels">
  <section class="panel">
    <h2>å—æŠ• åé–“é„‰å¤©æ°£ç‹€æ³</h2>
    <div class="weather-grid">
      <div class="weather-cell"><img id="weatherIcon" src=""><span>å¤©æ°£ï¼š<span id="weatherDesc">â€”</span></span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><span>æ°£æº«ï¼š<span id="weatherTemp">â€”</span> Â°C</span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/color/48/humidity.png"><span>æ¿•åº¦ï¼š<span id="weatherHumi">â€”</span> %</span></div>
      <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/umbrella-with-rain-drops.png"><span>é™é›¨é‡ï¼š<span id="rainfall">â€”</span> mm</span></div>
    </div>
  </section>

  <section class="panel">
    <h2>èŒ¶åœ’æº«æº¼åº¦æ„Ÿæ¸¬å™¨</h2>
    <div class="env-grid">
      <div class="env-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><div><span>æº«åº¦</span><br><span class="value" id="envTemp">â€”</span></div></div>
      <div class="env-cell"><img src="https://img.icons8.com/color/48/humidity.png"><div><span>æ¿•åº¦</span><br><span class="value" id="envHumi">â€”</span></div></div>
    </div>
  </section>
</div>

<section class="table-wrap">
  <div class="table-title">
    <h3>å„ç«™åœŸå£¤æ•¸æ“š</h3>

    <div class="depth-buttons"> 
      <button class="btn depth-btn active" data-depth="Surface">è¡¨é¢å±¤</button>
      <button class="btn depth-btn" data-depth="15cm">15 cm å±¤</button>
      <button class="btn depth-btn" data-depth="25cm">25 cm å±¤</button>

      <button class="btn" id="btnFullscreen">å…¨è¢å¹•</button>

      <!-- é€šçŸ¥é–‹é—œ -->
      <button class="btn" id="btnToggleNotify">é€šçŸ¥ ON/OFF</button>
      <span id="notifyStatus">é€šçŸ¥ï¼šå·²é–‹å•Ÿ</span>

      <button class="btn" id="btnNotify">ğŸ”” é€šçŸ¥æ¸¬è©¦</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>é …ç›®</th><th>æº«åº¦ (Â°C)</th><th>å«æ°´ç‡ (%)</th>
        <th>æ°® (N)</th><th>ç£· (P)</th><th>é‰€ (K)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer-line" id="footerInfo">æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼šâ€” ï½œ æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼šâ€” ï½œ ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼šâ€”</div>
</section>

<!-- ======================= SCRIPT START ======================= -->
<script>

/* ===================================================================
Â  Â â­ å…¨éƒ¨æ”¾é€² DOMContentLoadedï¼ˆç¢ºä¿æ‰€æœ‰å…ƒä»¶è¼‰å…¥å®Œæˆï¼‰
Â  Â =================================================================== */
window.addEventListener("DOMContentLoaded",()=>{

/* ============================================================
Â  Â 1. é€šçŸ¥é–‹é—œï¼ˆLocalStorageï¼‰
Â  Â ============================================================ */
let NOTIFY_ENABLED = true;

if(localStorage.getItem("tea_notify")==="off"){
Â  NOTIFY_ENABLED=false;
}

function updateNotifyUI(){
Â  const btn=document.getElementById("btnToggleNotify");
Â  const st =document.getElementById("notifyStatus");

Â  if(NOTIFY_ENABLED){
Â  Â  btn.classList.add("on");
Â  Â  st.textContent="é€šçŸ¥ï¼šå·²é–‹å•Ÿ";
Â  }else{
Â  Â  btn.classList.remove("on");
Â  Â  st.textContent="é€šçŸ¥ï¼šå·²é—œé–‰";
Â  }
}
updateNotifyUI();

document.getElementById("btnToggleNotify").onclick=()=>{
Â  NOTIFY_ENABLED=!NOTIFY_ENABLED;
Â  localStorage.setItem("tea_notify",NOTIFY_ENABLED?"on":"off");
Â  updateNotifyUI();
};

/* ============================================================
Â  Â 2. é€šçŸ¥ï¼ˆå« LINE + Webï¼‰
Â  Â ============================================================ */
async function sendNotification(title, body) {
Â  if(!NOTIFY_ENABLED) return;

Â  if(Notification.permission!=="granted"){
Â  Â  const perm=await Notification.requestPermission();
Â  Â  if(perm!=="granted") return;
Â  }

Â  new Notification(title,{
Â  Â  body,
Â  Â  icon:"https://img.icons8.com/color/96/tea.png"
Â  });
}

function sendLineNotify(title,message){
Â  if(!NOTIFY_ENABLED) return;

Â  fetch("https://script.google.com/macros/s/AKfycbyHvIZqDqpG4vXJSYxzx2F7KhmrVzLFWB3R1Fzx7VYG080RPTtaUdqJgupV4ZPPyM3_2g/exec",{
Â  Â  method:"POST",
Â  Â  headers:{"Content-Type":"application/x-www-form-urlencoded"},
Â  Â  body:`title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
Â  });
}

function alertTea(title,message){
Â  if(!NOTIFY_ENABLED) return;
Â  sendNotification(title,message);
Â  sendLineNotify(title,message);
Â  console.log("[AI é€šçŸ¥] ",title,message);
}

/* ============================================================
Â  Â 3. AI è­¦å ±è¦å‰‡ (å·²æ›´æ–°ç‚º Line å½™æ•´å ±å‘Šæ¨¡å¼)
Â  Â ============================================================ */
const ALERT_RULES={
Â  moisture:{low:20},
Â  temperature:{high:35,low:10},
Â  npk:{min:1,low:20}, // èˆŠæœ‰è¦å‰‡ï¼Œä¿ç•™ä½œç‚º UI é¡è‰²åˆ¤æ–·
Â  rain:{min:0.1},
Â  offline:{limitMinutes:10}
};

/* é‡å° LINE å ±å‘Šæ–°å¢çš„è¦å‰‡èˆ‡å»ºè­° */
const AI_RULES={
Â  temp:{
Â  Â  high:{ threshold:35, emoji:"ğŸ”¥ éé«˜", suggestion:"é®é™°ã€ç‘æ°´é™æº«" },
Â  Â  low:{ threshold:10, emoji:"â„ éä½", suggestion:"ä¿æº«" }
Â  },
Â  moist:{
Â  Â  low:{ threshold:20, emoji:"ğŸ’§ åä½", suggestion:"ç«‹å³çŒæº‰" }
Â  },
Â  N:{
Â  Â  low:{ threshold:10, emoji:"ğŸ”´ åš´é‡åä½", suggestion:"è£œå……æ°®è‚¥ï¼ˆå°¿ç´ ï¼‰" }
Â  },
Â  P:{
Â  Â  low:{ threshold:6, emoji:"ğŸ”´ åš´é‡åä½", suggestion:"è£œå……ç£·è‚¥ï¼ˆéç£·é…¸éˆ£ï¼‰" }
Â  },
Â  K:{
Â  Â  low:{ threshold:8, emoji:"ğŸ”´ åš´é‡åä½", suggestion:"è£œå……é‰€è‚¥ï¼ˆç¡«é…¸é‰€ï¼‰" }
Â  }
};

/* ============================================================
Â  Â 4. config
Â  Â ============================================================ */
const CONFIG={
Â  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
Â  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
Â  cwaStation:"C0I410",
Â  autoRefreshMinutes:1,
Â  stationCount:4,
Â  reportIntervalMinutes:10 // é™åˆ¶ AI è¨ºæ–·å ±å‘Šç™¼é€é »ç‡
};

/* ============================================================
Â  Â 5. æ™‚é–“å·¥å…·
Â  Â ============================================================ */
function pad(n){return n<10?"0"+n:n}
function nowStr(){
Â  const d=new Date();
Â  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function dateStr(){
Â  const d=new Date();
Â  const w=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()];
Â  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰`;
}
function roundInt(x){
Â  if(x==null||x==="") return "â€”";
Â  const n=Number(x);
Â  return isFinite(n)?Math.round(n):String(x);
}
/* åˆ¤æ–·æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­— */
function isValidNum(v){
Â  return v !== "â€”" && isFinite(Number(v));
}

/* ============================================================
Â  Â 6. AI é€šçŸ¥ç‹€æ…‹è¨˜éŒ„ï¼ˆæ”¹ç‚ºè¨˜éŒ„ä¸Šæ¬¡ç™¼é€æ™‚é–“ï¼‰
Â  Â ============================================================ */
// ä¸Šæ¬¡ç™¼é€å®Œæ•´ AI å ±å‘Šçš„æ™‚é–“
let lastSentReport = 0;
// ä¸Šæ¬¡ç™¼é€é›¨é‡é€šçŸ¥çš„æ™‚é–“
let lastRainNotify = 0;
// ä¸Šæ¬¡ç™¼é€æ‰ç·šé€šçŸ¥çš„æ™‚é–“
let lastOfflineNotify = 0;

/* ============================================================
Â  Â 7. è¨ºæ–·æ ¸å¿ƒèˆ‡å ±å‘Šç”Ÿæˆ
Â  Â ============================================================ */
let lastStationData = []; // å„²å­˜ä¸Šæ¬¡æ›´æ–°çš„è³‡æ–™ï¼Œä¾›è¨ºæ–·ä½¿ç”¨
let weatherRain = 0; // å„²å­˜é™é›¨é‡

/* æª¢æŸ¥é™é›¨ (ç¨ç«‹æ–¼ç«™é»è¨ºæ–·) */
function checkRain(v){
Â  const rain = Number(v || 0);
Â  if(rain >= ALERT_RULES.rain.min && Date.now() - lastRainNotify > 3600000){ // 1 å°æ™‚å…§åªç™¼ä¸€æ¬¡
Â  Â  alertTea("ğŸŒ§ é–‹å§‹ä¸‹é›¨",`åé–“é™é›¨é‡ï¼š${rain} mm`);
Â  Â  lastRainNotify = Date.now();
Â  }
Â  weatherRain = rain;
}

/* æª¢æŸ¥æ„Ÿæ¸¬å™¨é›¢ç·šç‹€æ…‹ */
let lastUpdateTime=Date.now();
function checkOffline(){
Â  const limitMs=ALERT_RULES.offline.limitMinutes*60*1000;
Â  if(Date.now()-lastUpdateTime>limitMs && Date.now() - lastOfflineNotify > 300000){ // 5 åˆ†é˜å…§åªç™¼ä¸€æ¬¡
Â  Â  alertTea("âš  æ„Ÿæ¸¬å™¨æ‰ç·š",`å·² ${ALERT_RULES.offline.limitMinutes} åˆ†é˜ç„¡æ›´æ–°`);
Â  Â  lastOfflineNotify = Date.now();
Â  }
}
setInterval(checkOffline,10000);

/* AI è¨ºæ–·ä¸¦ç”Ÿæˆå ±å‘Š */
function runAIDiagnosisAndReport(){
Â  const totalMinutes = CONFIG.reportIntervalMinutes;
Â  // æª¢æŸ¥ç™¼é€é »ç‡ (10 åˆ†é˜å…§åªç™¼é€ä¸€æ¬¡)
Â  if(Date.now() - lastSentReport < totalMinutes * 60 * 1000) return;

Â  const allStationProblems = [];

Â  // éæ­·æ‰€æœ‰ç«™é»
Â  for(let s=1;s<=CONFIG.stationCount;s++){
Â  Â  const station = lastStationData[s-1];
Â  Â  if(!station) continue;

Â  Â  const problems = []; // è©²ç«™é»æ‰€æœ‰å•é¡Œ
Â  Â  const {temp, moist, N, P, K} = station;

Â  Â  // æª¢æŸ¥åœŸå£¤æº«åº¦
Â  Â  if(isValidNum(temp)){
Â  Â  Â  if(Number(temp) >= AI_RULES.temp.high.threshold)
Â  Â  Â  Â  problems.push(`åœŸå£¤æº«åº¦ï¼š${temp} ${AI_RULES.temp.high.emoji}\nâ†’ å»ºè­°ï¼š${AI_RULES.temp.high.suggestion}`);
Â  Â  Â  else if(Number(temp) <= AI_RULES.temp.low.threshold)
Â  Â  Â  Â  problems.push(`åœŸå£¤æº«åº¦ï¼š${temp} ${AI_RULES.temp.low.emoji}\nâ†’ å»ºè­°ï¼š${AI_RULES.temp.low.suggestion}`);
Â  Â  }

Â  Â  // æª¢æŸ¥å«æ°´ç‡
Â  Â  if(isValidNum(moist) && Number(moist) < AI_RULES.moist.low.threshold)
Â  Â  Â  problems.push(`å«æ°´ç‡ï¼š${moist} ${AI_RULES.moist.low.emoji}\nâ†’ å»ºè­°ï¼š${AI_RULES.moist.low.suggestion}`);

Â  Â  // æª¢æŸ¥ NPK
Â  Â  [
Â  Â  Â  {key:'N', val:N}, {key:'P', val:P}, {key:'K', val:K}
Â  Â  ].forEach(({key,val})=>{
Â  Â  Â  if(isValidNum(val) && Number(val) < AI_RULES[key].low.threshold){
Â  Â  Â  Â  problems.push(
Â  Â  Â  Â  Â  `${key}ï¼š${val} ${AI_RULES[key].low.emoji}\nâ†’ å»ºè­°ï¼š${AI_RULES[key].low.suggestion}`.replace("N","æ°®").replace("P","ç£·").replace("K","é‰€")
Â  Â  Â  Â  );
Â  Â  Â  }
Â  Â  });

Â  Â  // å½™æ•´ç«™é»çµæœ
Â  Â  if(problems.length > 0){
Â  Â  Â  allStationProblems.push(`ã€ç¬¬${s}ç«™ã€‘\n${problems.join('\n\n')}`);
Â  Â  }else{
Â  Â  Â  allStationProblems.push(`ã€ç¬¬${s}ç«™ã€‘\nğŸŸ¢ å…¨éƒ¨æ­£å¸¸`);
Â  Â  }
Â  }

Â  // ç”Ÿæˆæœ€çµ‚å ±å‘Š
Â  const header = "ğŸ“¡ ç‘æˆæ™ºæ…§èŒ¶åœ’ AI é¤Šåˆ†èˆ‡åœŸå£¤è¨ºæ–·å ±å‘Š\nï¼ˆä¾ç«™é»æ’åºï¼‰\n\n";
Â  const reportBody = allStationProblems.join('\n\n');

Â  // å ±å‘Šèˆ‡ä¸Šæ¬¡ä¸åŒæ‰ç™¼é€
Â  if(localStorage.getItem("lastReportBody") !== reportBody){
Â  Â  const fullReport = header + reportBody;
Â  Â  alertTea("æ™ºæ…§èŒ¶åœ’ AI è¨ºæ–·", fullReport);
Â  Â  
Â  Â  localStorage.setItem("lastReportBody", reportBody);
Â  Â  lastSentReport = Date.now();
Â  }else{
Â  Â  // å³ä½¿å ±å‘Šç›¸åŒï¼Œå¦‚æœè¶…é 24 å°æ™‚ï¼Œä¹Ÿç™¼é€ä¸€æ¬¡ã€Œå…¨éƒ¨æ­£å¸¸ã€çš„å ±å‘Š
Â  Â  if(Date.now() - lastSentReport > 24 * 60 * 60 * 1000){
Â  Â  Â  alertTea("æ™ºæ…§èŒ¶åœ’ AI è¨ºæ–·", fullReport);
Â  Â  Â  lastSentReport = Date.now();
Â  Â  }
Â  }
}


/* ============================================================
Â  Â 8. æ•¸å€¼é¡è‰² (ä¿ç•™åŸé‚è¼¯ä¾› Dashboard UI ä½¿ç”¨)
Â  Â ============================================================ */
function colorClass(type,v){
Â  if(v==="â€”"||v==null||v==="") return "";
Â  v=Number(v);
Â  switch(type){
Â  Â  case "temp":
Â  Â  Â  if(v<ALERT_RULES.temperature.low) return "val-warn";
Â  Â  Â  if(v<28) return "val-ok";
Â  Â  Â  if(v<ALERT_RULES.temperature.high) return "val-warn";
Â  Â  Â  return "val-bad";
Â  Â  case "moist":
Â  Â  Â  if(v<ALERT_RULES.moisture.low) return "val-bad";
Â  Â  Â  if(v<35) return "val-warn";
Â  Â  Â  if(v<70) return "val-ok";
Â  Â  Â  return "val-warn";
Â  Â  case "n":
Â  Â  case "p":
Â  Â  case "k":
Â  Â  Â  if(v===0) return "val-bad";
Â  Â  Â  if(v<ALERT_RULES.npk.low) return "val-warn";
Â  Â  Â  return "val-ok";
Â  Â  default: return "";
Â  }
}

/* ============================================================
Â  Â 9. è¡¨æ ¼è³‡æ–™æ›´æ–°
Â  Â ============================================================ */
let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes*60;
let currentDepth = "Surface"; // æ–°å¢è®Šæ•¸è¨˜éŒ„ç•¶å‰æ·±åº¦

function updateFooter(){
Â  const m=Math.floor(remainingSec/60);
Â  const s=pad(remainingSec%60);
Â  document.getElementById("footerInfo").textContent=
Â  Â  `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime} ï½œ æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime} ï½œ ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

async function fetchCSV(){
Â  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now());
Â  const text=await res.text();
Â  const lines=text.trim().split(/\r?\n/).map(l=>l.split(','));
Â  return {cols:lines[0],rows:lines.slice(1)};
}

function getLastValid(rows){
Â  for(let i=rows.length-1;i>=0;i--)
Â  Â  if(rows[i].some(v=>v!=="")) return rows[i];
Â  return null;
}

async function refreshSheet(depth=currentDepth){
Â  currentDepth = depth; // å„²å­˜ç•¶å‰æ·±åº¦
Â  
Â  try{
Â  Â  const {cols,rows}=await fetchCSV();
Â  Â  const last=getLastValid(rows);
Â  Â  if(!last) return;

Â  Â  const idx={};
Â  Â  cols.forEach((c,i)=>idx[c.toLowerCase()]=i);

Â  Â  genTime=last[idx["time"]]||"â€”";
Â  Â  lastUpdateTime=Date.now();
Â  Â  updateFooter();

Â  Â  document.getElementById("envTemp").textContent =
Â  Â  Â  roundInt(last[idx["teagarden_air_temp"]]);

Â  Â  document.getElementById("envHumi").textContent =
Â  Â  Â  roundInt(last[idx["teagarden_air_humidity"]]);

Â  Â  const tbody=document.getElementById("tbody");
Â  Â  tbody.innerHTML="";
Â  Â  
Â  Â  // å½™æ•´æ‰€æœ‰ç«™é»è³‡æ–™ (AI å ±å‘Šåªç”¨ Surface è¡¨é¢å±¤è³‡æ–™)
Â  Â  const allStationData = [];
Â  Â  const depthKey = depth.toLowerCase();

Â  Â  for(let s=1;s<=CONFIG.stationCount;s++){
Â  Â  Â  const p=`station${s}_${depthKey}`;
Â  Â  Â  const pSurface = `station${s}_surface`;

Â  Â  Â  // 1. å–å¾—ç•¶å‰æ·±åº¦è³‡æ–™ (ä¾› UI é¡¯ç¤º)
Â  Â  Â  const soilTemp=roundInt(last[idx[`${p}_soiltemp`]]);
Â  Â  Â  const soilMoist=roundInt(last[idx[`${p}_soilmoisture`]]);
Â  Â  Â  const n=roundInt(last[idx[`${p}_nitrogen`]]);
Â  Â  Â  const p2=roundInt(last[idx[`${p}_phosphorus`]]);
Â  Â  Â  const k=roundInt(last[idx[`${p}_potassium`]]);

Â  Â  Â  // 2. å–å¾— Surface å±¤è³‡æ–™ (ä¾› AI è¨ºæ–·)
Â  Â  Â  const surfaceTemp = roundInt(last[idx[`${pSurface}_soiltemp`]]);
Â  Â  Â  const surfaceMoist = roundInt(last[idx[`${pSurface}_soilmoisture`]]);
Â  Â  Â  const surfaceN = roundInt(last[idx[`${pSurface}_nitrogen`]]);
Â  Â  Â  const surfaceP = roundInt(last[idx[`${pSurface}_phosphorus`]]);
Â  Â  Â  const surfaceK = roundInt(last[idx[`${pSurface}_potassium`]]);

Â  Â  Â  allStationData.push({
Â  Â  Â  Â  station: s,
Â  Â  Â  Â  temp: surfaceTemp,
Â  Â  Â  Â  moist: surfaceMoist,
Â  Â  Â  Â  N: surfaceN,
Â  Â  Â  Â  P: surfaceP,
Â  Â  Â  Â  K: surfaceK
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  // 3. æ›´æ–°è¡¨æ ¼ UI (ä½¿ç”¨ç•¶å‰æ·±åº¦è³‡æ–™)
Â  Â  Â  const tr=document.createElement("tr");
Â  Â  Â  tr.innerHTML=`
Â  Â  Â  Â  <td>ç¬¬${s}ç«™</td>
Â  Â  Â  Â  <td class="${colorClass('temp',soilTemp)}">${soilTemp}</td>
Â  Â  Â  Â  <td class="${colorClass('moist',soilMoist)}">${soilMoist}</td>
Â  Â  Â  Â  <td class="${colorClass('n',n)}">${n}</td>
Â  Â  Â  Â  <td class="${colorClass('p',p2)}">${p2}</td>
Â  Â  Â  Â  <td class="${colorClass('k',k)}">${k}</td>
Â  Â  Â  `;
Â  Â  Â  tbody.appendChild(tr);
Â  Â  }

Â  Â  // 4. åŸ·è¡Œ AI è¨ºæ–· (åªå° Surface å±¤è³‡æ–™)
Â  Â  lastStationData = allStationData;
Â  Â  runAIDiagnosisAndReport();

Â  }catch(e){
Â  Â  console.warn("CSV éŒ¯èª¤:",e);
Â  }
}

/* ============================================================
Â  Â 10. å¤©æ°£æ›´æ–°
Â  Â ============================================================ */
async function refreshWeather(){
Â  try{
Â  Â  const url=
Â  Â  Â  `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?`+
Â  Â  Â  `Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;

Â  Â  const res=await fetch(url);
Â  Â  const js=await res.json();
Â  Â  const st=js.records?.Station?.[0];
Â  Â  const w=st?.WeatherElement||{};

Â  Â  document.getElementById("weatherDesc").textContent = w.Weather || "â€”";
Â  Â  document.getElementById("weatherTemp").textContent = roundInt(w.AirTemperature);
Â  Â  document.getElementById("weatherHumi").textContent = roundInt(w.RelativeHumidity);
Â  Â  const rain = roundInt(w.Now?.Precipitation);
Â  Â  document.getElementById("rainfall").textContent = rain;

Â  Â  checkRain(rain); // åŸ·è¡Œé™é›¨æª¢æŸ¥

Â  Â  document.getElementById("weatherIcon").src =
Â  Â  Â  w.Weather?.includes("é›¨")
Â  Â  Â  Â  ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
Â  Â  Â  Â  : "https://img.icons8.com/emoji/48/sun-emoji.png";

Â  Â  weatherTime = st?.ObsTime?.DateTime?.replace("T"," ").slice(0,19) || "â€”";
Â  Â  updateFooter();

Â  }catch(e){
Â  Â  console.warn("æ°£è±¡éŒ¯èª¤:",e);
Â  }
}

/* ============================================================
Â  Â 11. UI è¡Œç‚º + è‡ªå‹•åˆ·æ–°
Â  Â ============================================================ */
document.querySelectorAll(".depth-btn").forEach(btn=>{
Â  btn.addEventListener("click",()=>{
Â  Â  document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
Â  Â  btn.classList.add("active");

Â  Â  refreshSheet(btn.dataset.depth);
Â  });
});

document.getElementById("btnFullscreen").onclick=
Â  ()=>document.documentElement.requestFullscreen?.();

document.getElementById("btnNotify").onclick=
Â  ()=>alertTea("ğŸ”” æ¸¬è©¦é€šçŸ¥","é€™æ˜¯ä¸€å‰‡æ¸¬è©¦ï¼ˆå« LINE + ç€è¦½å™¨ï¼‰");

(function tick(){
Â  document.getElementById("mainClock").textContent=nowStr();
Â  document.getElementById("dateBox").textContent=dateStr();
Â  setTimeout(tick,250);
})();

setInterval(()=>{
Â  remainingSec--;
Â  if(remainingSec<=0){
Â  Â  // åˆ·æ–°é é¢ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼æˆ–è³‡æ–™é€£ç·šå•é¡Œ
Â  Â  location.replace(location.href.split("?")[0]+"?t="+Date.now());
Â  Â  return;
Â  }
Â  updateFooter();
},1000);

/* ============================================================
Â  Â 12. åˆå§‹åŒ–
Â  Â ============================================================ */
refreshSheet();
refreshWeather();

});Â  // DOMContentLoaded END
</script>

<!-- ===== Dialogflow Messenger æ¨£å¼ ===== -->
<style>
  df-messenger {
    --df-messenger-bot-message: #245953;
    --df-messenger-button-titlebar-color: #245953;
    --df-messenger-chat-background-color: #E7F6E7;
    --df-messenger-font-color: #000;
  }
</style>

<!-- ===== Dialogflow Messenger ä¸»ç¨‹å¼ ===== -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
<df-messenger
  intent="WELCOME"
  chat-title="ç‘æˆèŒ¶åœ’æ™ºæ…§åŠ©æ‰‹"
  agent-id="8b30913c-be1a-4cd9-9309-136c81726d04"
  language-code="zh-tw"
></df-messenger>

</body>
</html>
