<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v7.3</title>

<style>
/* ===== åŸºæœ¬é¡è‰² ===== */
:root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}

/* ===== Layout ===== */
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}

header{
  display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;
  align-items:stretch;
}

.title{
  background:#e8f7ee;
  border:4px solid var(--panel);
  border-radius:var(--radius);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;padding:12px;
}
.title h1{
  margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;
}

.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  font-weight:700;
}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}

/* ===== å¤©æ°£å€ ===== */
.top-panels{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:var(--gap);
  margin-top:var(--gap);
}
.panel{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:12px;
}
.panel h2{
  margin:0 0 8px 0;font-size:28px;
}

.weather-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;
  background:var(--tile);border-radius:14px;padding:12px;
}
.weather-cell{
  display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;
}
.weather-cell img{
  width:36px;height:36px;
}

/* ===== æº«æ¿•åº¦ ===== */
.env-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  background:var(--tile);border-radius:14px;padding:12px;
}
.env-cell{
  display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;color:var(--num);
}
.env-cell img{
  width:50px;height:50px;
}
.env-cell .value{
  font-size:36px;font-weight:800
}

/* ===== åœŸå£¤è¡¨ ===== */
.table-wrap{
  margin-top:var(--gap);
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px;
}
.table-title{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;flex-wrap:wrap;gap:10px;
}
.table-title h3{
  margin:0;font-size:26px;
}
.btn{
  background:var(--panel);color:#fff;border:none;border-radius:999px;
  padding:10px 0;width:130px;font-size:20px;font-weight:800;cursor:pointer;
}
.btn:active{
  transform:translateY(1px);
}
.depth-btn.active{
  background:var(--ok);
}

/* é€šçŸ¥é–‹é—œ */
#btnToggleNotify{
  width:150px;background:#777;
}
#btnToggleNotify.on{
  background:#16a34a !important;
}
#notifyStatus{
  font-size:17px;font-weight:800;color:#0b2d2a;margin-left:8px;
}

/* è¡¨æ ¼ */
table{
  width:100%;border-collapse:separate;border-spacing:0 10px;
}
thead th{
  font-size:18px;color:#334155;text-align:center;
}
tbody td,thead th{
  padding:10px 8px;
}
tbody tr{
  background:var(--tile);
}
tbody tr td{
  font-size:22px;text-align:center;font-weight:700;color:var(--num)
}
tbody tr td:first-child{
  font-weight:800;color:#1f2937;
}

/* åº•éƒ¨è³‡è¨Š */
.footer-line{
  color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;
}

/* æ•¸å€¼é¡è‰² */
.val-ok   { color:#0f9d58 !important;font-weight:900; }
.val-warn { color:#f4b400 !important;font-weight:900; }
.val-bad  { color:#db4437 !important;font-weight:900; }

/* ===========================
   ğŸŒŸ Dialogflow Messenger é®®è±”äº®è‰²ä¸»é¡Œ
   =========================== */
df-messenger {
  --df-messenger-bot-message: #00C853;       /* äº®ç¶ ï¼ˆæ©Ÿå™¨äººè¨Šæ¯ï¼‰ */
  --df-messenger-button-titlebar-color: #00E676;  /* æ¨™é¡Œåˆ—äº®ç¶  */
  --df-messenger-chat-background-color: #E2FBE2;  /* è¶…æ·¡èŒ¶ç¶ èƒŒæ™¯ */
  --df-messenger-font-color: #000;
  --df-messenger-user-message: #245953;     /* ä½¿ç”¨è€…è¨Šæ¯æ·±ç¶  */
}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="datebox" id="dateBox">--</div>
  <div class="title">
    <h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1>
    <small>Real-time Dashboard v7.3</small>
  </div>
  <div class="clock"><div id="mainClock">00:00:00</div></div>
</header>


  <!-- ======================= SCRIPT START ======================= -->
<script>
window.addEventListener("DOMContentLoaded",()=>{

/* ============================================================
   1. é€šçŸ¥é–‹é—œï¼ˆLocalStorageï¼‰
   ============================================================ */
let NOTIFY_ENABLED = true;
if(localStorage.getItem("tea_notify")==="off"){ NOTIFY_ENABLED=false; }

function updateNotifyUI(){
  const btn=document.getElementById("btnToggleNotify");
  const st =document.getElementById("notifyStatus");
  if(NOTIFY_ENABLED){
    btn.classList.add("on");
    st.textContent="é€šçŸ¥ï¼šå·²é–‹å•Ÿ";
  }else{
    btn.classList.remove("on");
    st.textContent="é€šçŸ¥ï¼šå·²é—œé–‰";
  }
}
updateNotifyUI();

document.getElementById("btnToggleNotify").onclick=()=>{
  NOTIFY_ENABLED=!NOTIFY_ENABLED;
  localStorage.setItem("tea_notify",NOTIFY_ENABLED?"on":"off");
  updateNotifyUI();
};

/* ============================================================
   2. é€šçŸ¥ï¼ˆLINE + WEBï¼‰
   ============================================================ */
async function sendNotification(title, body) {
  if(!NOTIFY_ENABLED) return;

  if(Notification.permission!=="granted"){
    const perm=await Notification.requestPermission();
    if(perm!=="granted") return;
  }

  new Notification(title,{
    body,
    icon:"https://img.icons8.com/color/96/tea.png"
  });
}

function sendLineNotify(title,message){
  if(!NOTIFY_ENABLED) return;

  fetch("https://script.google.com/macros/s/AKfycbyHvIZqDqpG4vXJSYxzx2F7KhmrVzLFWB3R1Fzx7VYG080RPTtaUdqJgupV4ZPPyM3_2g/exec",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
  });
}

function alertTea(title,message){
  if(!NOTIFY_ENABLED) return;
  sendNotification(title,message);
  sendLineNotify(title,message);
  console.log("[AI é€šçŸ¥] ",title,message);
}

/* ============================================================
   â­â­ 3. AI è±ªè¯ç‰ˆ N / P / K å½™æ•´é€šçŸ¥
   ============================================================ */

/*
  nutrientAlert = {
    "ç¬¬ä¸€ç«™": [ {type:"N", value:4}, {type:"P",value:5}, ... ],
    "ç¬¬äºŒç«™": [],
    ...
  }
*/
let nutrientAlert = {
  "ç¬¬ä¸€ç«™": [],
  "ç¬¬äºŒç«™": [],
  "ç¬¬ä¸‰ç«™": [],
  "ç¬¬å››ç«™": []
};

const LIMIT = { N:20, P:15, K:10 };

// é¡è‰²ç­‰ç´š
function levelEmoji(type,value){
  let L = LIMIT[type];
  if(value < L*0.5) return "ğŸ”´ï¼ˆåš´é‡åä½ï¼‰";
  if(value < L*0.8) return "ğŸŸ ï¼ˆåä½ï¼‰";
  if(value < L)     return "ğŸŸ¡ï¼ˆç•¥ä½ï¼‰";
  return "ğŸŸ¢ï¼ˆæ­£å¸¸ï¼‰";
}

// AI å»ºè­°
function advice(type){
  switch(type){
    case "N": return "å»ºè­°è£œå……å«æ°®è‚¥ï¼ˆå°¿ç´ ã€ç¡«éŠ¨ã€ç¡é…¸éŠ¨ï¼‰ã€‚";
    case "P": return "è£œå……ç£·è‚¥ï¼ˆéç£·é…¸éˆ£ï¼‰ã€‚";
    case "K": return "è£œå……é‰€è‚¥ï¼ˆæ°¯åŒ–é‰€ã€ç¡«é…¸é‰€ï¼‰ã€‚";
  }
  return "";
}

// â˜… æ¯æ¬¡æ•¸æ“šé€²å…¥ â†’ ç´¯ç©åˆ° nutrientAlert
function handleNPK(station,type,value){
  if(value==="â€”" || value==null) return;
  nutrientAlert[station].push({type,value});
}

// ç”¢ç”Ÿæœ€çµ‚åŒ¯ç¸½é€šçŸ¥
function buildNPKReport(){
  let text = "ğŸ“¡ ç‘æˆæ™ºæ…§èŒ¶åœ’é¤Šåˆ†è¨ºæ–·å ±å‘Š\nï¼ˆAI è‡ªå‹•åˆ†æï¼‰\n\n";

  ["ç¬¬ä¸€ç«™","ç¬¬äºŒç«™","ç¬¬ä¸‰ç«™","ç¬¬å››ç«™"].forEach(st=>{
    text += `ã€${st}ã€‘\n`;

    if(nutrientAlert[st].length === 0){
      text += "ğŸŸ¢ å…¨éƒ¨æ­£å¸¸\n\n";
      return;
    }

    let hasIssue=false;

    nutrientAlert[st].forEach(item=>{
      const {type,value} = item;
      const mark = levelEmoji(type,value);
      text += `${type}=${value} ${mark}\n`;
      if(mark !== "ğŸŸ¢ï¼ˆæ­£å¸¸ï¼‰") hasIssue=true;
    });

    if(hasIssue){
      text += "\nğŸ”§ å»ºè­°ï¼š\n";
      nutrientAlert[st].forEach(item=>{
        const {type,value}=item;
        const mark = levelEmoji(type,value);
        if(mark !== "ğŸŸ¢ï¼ˆæ­£å¸¸ï¼‰"){
          text += `ãƒ»${type} åä½ â†’ ${advice(type)}\n`;
        }
      });
    }
    text += "\n";
  });

  return text;
}

// ç™¼é€ï¼‹æ¸…ç©º
function sendAllNPKAlert(){
  const msg = buildNPKReport();

  // å…¨éƒ¨æ­£å¸¸ â†’ ä¸é€šçŸ¥
  const allOK = Object.values(nutrientAlert).every(list =>
    list.every(item => levelEmoji(item.type,item.value)==="ğŸŸ¢ï¼ˆæ­£å¸¸ï¼‰")
  );
  if(allOK) return;

  alertTea("ğŸŒ± é¤Šåˆ†é€šçŸ¥ï¼ˆAI åˆ†æï¼‰", msg);

  nutrientAlert = {
    "ç¬¬ä¸€ç«™": [],
    "ç¬¬äºŒç«™": [],
    "ç¬¬ä¸‰ç«™": [],
    "ç¬¬å››ç«™": []
  };
}

/* ============================================================
   â­ 4. ä½ çš„åŸæœ¬è­¦å ±ç³»çµ±ï¼ˆæ¿•åº¦/æº«åº¦/é›¨/æ‰ç·šï¼‰
   ============================================================ */
const ALERT_RULES={
  moisture:{low:20},
  temperature:{high:35,low:10},
  rain:{min:0.1},
  offline:{limitMinutes:10}
};

let notified={
  moisture:{}, temp:{}, weather:false, offline:false
};

function checkMoisture(s,v){
  if(v<ALERT_RULES.moisture.low && !notified.moisture[s]){
    alertTea("åœŸå£¤å«æ°´ç‡åä½",`ç¬¬ ${s} ç«™åƒ… ${v}%`);
    notified.moisture[s]=true;
  }
}

function checkSoilTemp(s,v){
  const {high,low}=ALERT_RULES.temperature;
  if(v>high && !notified.temp[s+"_high"]){
    alertTea("åœŸå£¤æº«åº¦éé«˜",`ç¬¬ ${s} ç«™ ${v}Â°C`);
    notified.temp[s+"_high"]=true;
  }
  if(v<low && !notified.temp[s+"_low"]){
    alertTea("åœŸå£¤éå†·",`ç¬¬ ${s} ç«™åƒ… ${v}Â°C`);
    notified.temp[s+"_low"]=true;
  }
}

function checkRain(v){
  if(v>=ALERT_RULES.rain.min && !notified.weather){
    alertTea("ğŸŒ§ é–‹å§‹ä¸‹é›¨",`åé–“é™é›¨é‡ï¼š${v} mm`);
    notified.weather=true;
  }
}

let lastUpdateTime=Date.now();
function checkOffline(){
  const limit=ALERT_RULES.offline.limitMinutes*60000;
  if(!notified.offline && Date.now()-lastUpdateTime>limit){
    alertTea("âš  æ„Ÿæ¸¬å™¨æ‰ç·š",`${ALERT_RULES.offline.limitMinutes} åˆ†é˜ç„¡æ›´æ–°`);
    notified.offline=true;
  }
}
setInterval(checkOffline,10000);

/* ============================================================
   5. CSV + å¤©æ°£ + æ¸²æŸ“è¡¨æ ¼
   ============================================================ */
const CONFIG={
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};

function pad(n){return n<10?"0"+n:n;}
function nowStr(){
  const d=new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function dateStr(){
  const d=new Date();
  const w=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()];
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰`;
}
function roundInt(x){
  if(x==null||x==="") return "â€”";
  const n=Number(x);
  return isFinite(n)?Math.round(n):String(x);
}

/* æ•¸å€¼é¡è‰²åˆ†é¡ */
function colorClass(type,v){
  if(v==="â€”") return "";
  v=Number(v);
  switch(type){
    case "temp":  if(v<10) return "val-warn"; if(v<28) return "val-ok"; if(v<35)return"val-warn"; return"val-bad";
    case "moist": if(v<20) return "val-bad"; if(v<35)return"val-warn"; if(v<70)return"val-ok"; return"val-warn";
    case "n":
    case "p":
    case "k":
      if(v===0) return "val-bad";
      if(v<20)  return "val-warn";
      return "val-ok";
  }
  return "";
}

let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes*60;

function updateFooter(){
  const m=Math.floor(remainingSec/60);
  const s=pad(remainingSec%60);
  document.getElementById("footerInfo").textContent=
    `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime} ï½œ æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime} ï½œ ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now());
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(','));
  return {cols:lines[0],rows:lines.slice(1)};
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--)
    if(rows[i].some(v=>v!=="")) return rows[i];
  return null;
}

async function refreshSheet(depth="Surface"){
  try{
    const {cols,rows}=await fetchCSV();
    const last=getLastValid(rows);
    if(!last) return;

    const idx={};
    cols.forEach((c,i)=>idx[c.toLowerCase()]=i);

    genTime=last[idx["time"]]||"â€”";
    lastUpdateTime=Date.now();
    updateFooter();

    document.getElementById("envTemp").textContent =
      roundInt(last[idx["teagarden_air_temp"]]);

    document.getElementById("envHumi").textContent =
      roundInt(last[idx["teagarden_air_humidity"]]);

    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    for(let s=1;s<=CONFIG.stationCount;s++){
      const p=`station${s}_${depth.toLowerCase()}`;

      const soilTemp=roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist=roundInt(last[idx[`${p}_soilmoisture`]]);
      const n=roundInt(last[idx[`${p}_nitrogen`]]);
      const p2=roundInt(last[idx[`${p}_phosphorus`]]);
      const k=roundInt(last[idx[`${p}_potassium`]]);

      /* åŸæœ¬ AI åŸºç¤æé†’ */
      checkMoisture(s,soilMoist);
      checkSoilTemp(s,soilTemp);

      /* â˜… åŠ å…¥å½™æ•´å¼ NPK â˜… */
      handleNPK(`ç¬¬${s}ç«™`,"N",n);
      handleNPK(`ç¬¬${s}ç«™`,"P",p2);
      handleNPK(`ç¬¬${s}ç«™`,"K",k);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>ç¬¬${s}ç«™</td>
        <td class="${colorClass('temp',soilTemp)}">${soilTemp}</td>
        <td class="${colorClass('moist',soilMoist)}">${soilMoist}</td>
        <td class="${colorClass('n',n)}">${n}</td>
        <td class="${colorClass('p',p2)}">${p2}</td>
        <td class="${colorClass('k',k)}">${k}</td>
      `;
      tbody.appendChild(tr);
    }

    /* â˜…â˜… å››ç«™å…¨éƒ¨è·‘å®Œ â†’ ç™¼é€ä¸€æ¬¡å½™æ•´é€šçŸ¥ â˜…â˜… */
    sendAllNPKAlert();

  }catch(e){
    console.warn("CSV éŒ¯èª¤:",e);
  }
}

/* ============================================================
   6. å¤©æ°£æ›´æ–°
   ============================================================ */
async function refreshWeather(){
  try{
    const url=
      `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?`+
      `Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;

    const res=await fetch(url);
    const js=await res.json();
    const st=js.records?.Station?.[0];
    const w=st?.WeatherElement||{};

    document.getElementById("weatherDesc").textContent = w.Weather || "â€”";
    document.getElementById("weatherTemp").textContent = roundInt(w.AirTemperature);
    document.getElementById("weatherHumi").textContent = roundInt(w.RelativeHumidity);
    document.getElementById("rainfall").textContent = roundInt(w.Now?.Precipitation);

    checkRain(Number(w.Now?.Precipitation||0));

    document.getElementById("weatherIcon").src =
      w.Weather?.includes("é›¨")
        ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
        : "https://img.icons8.com/emoji/48/sun-emoji.png";

    weatherTime = st?.ObsTime?.DateTime?.replace("T"," ").slice(0,19) || "â€”";
    updateFooter();

  }catch(e){
    console.warn("å¤©æ°£éŒ¯èª¤:",e);
  }
}

/* ============================================================
   7. UI + è‡ªå‹•åˆ·æ–°
   ============================================================ */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    refreshSheet(btn.dataset.depth);
  });
});

document.getElementById("btnFullscreen").onclick=
  ()=>document.documentElement.requestFullscreen?.();

document.getElementById("btnNotify").onclick=
  ()=>alertTea("ğŸ”” æ¸¬è©¦é€šçŸ¥","é€™æ˜¯ä¸€å‰‡æ¸¬è©¦ï¼ˆå« LINE + Webï¼‰");

(function tick(){
  document.getElementById("mainClock").textContent=nowStr();
  document.getElementById("dateBox").textContent=dateStr();
  setTimeout(tick,250);
})();

setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0){
    location.replace(location.href.split("?")[0]+"?t="+Date.now());
    return;
  }
  updateFooter();
},1000);

/* ============================================================
   8. åˆå§‹åŒ–
   ============================================================ */
refreshSheet();
refreshWeather();

}); // DOM Loaded END
</script>


  <!-- ======================= Dialogflow Messenger Auto Fix ======================= -->
<script>
/* ============================================================
   â­ df-messenger è‡ªå‹•ä¿®å¾©æ©Ÿåˆ¶ï¼ˆé¿å…ä¸é¡¯ç¤ºçš„ Bugï¼‰
   ============================================================ */
function ensureChatbotLoaded() {
  const bot = document.querySelector("df-messenger");

  if (bot && !bot.shadowRoot) {
    console.warn("df-messenger æœªåˆå§‹åŒ– â†’ é‡æ–°å»ºç«‹...");

    const attr = {
      intent: bot.getAttribute("intent"),
      "chat-title": bot.getAttribute("chat-title"),
      "agent-id": bot.getAttribute("agent-id"),
      "language-code": bot.getAttribute("language-code")
    };

    bot.remove();

    const newBot = document.createElement("df-messenger");
    for (const k in attr) newBot.setAttribute(k, attr[k]);
    document.body.appendChild(newBot);
  }
}

window.addEventListener("dfMessengerLoaded", () => {
  console.log("df-messenger æˆåŠŸè¼‰å…¥ï¼");
});

setTimeout(ensureChatbotLoaded, 1200);

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    setTimeout(ensureChatbotLoaded, 400);
  }
});
</script>

<!-- ======================= Dialogflow Messenger ä¸»ç¨‹å¼ ======================= -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>

<df-messenger
  intent="WELCOME"
  chat-title="ç‘æˆèŒ¶åœ’æ™ºæ…§åŠ©æ‰‹"
  agent-id="8b30913c-be1a-4cd9-9309-136c81726d04"
  language-code="zh-tw"
></df-messenger>

</div> <!-- wrap çµå°¾ -->

</body>
</html>
