<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v6.9</title>
<style>
    /*  https://script.google.com/macros/s/AKfycbydBypZcNm9Gb4uz_02ATyWhKw4dmvaYgExpjyz_1_nm9wNGd9H4DmWqIj-Qlth94qC/exec  æ­£å¸¸å›ç­” tea123 */
    /*  https://script.google.com/macros/s/AKfycbxsX8kHFNPb7481PeQv2VukW8JYEYa-qNBUhysRDkczXvCwX9BxtE-hJe48QG53P1Hbyg/exec     æ­£å¸¸å›ç­”   tea112603      */
/* gas https://script.google.com/macros/s/AKfycbydBypZcNm9Gb4uz_02ATyWhKw4dmvaYgExpjyz_1_nm9wNGd9H4DmWqIj-Qlth94qC/exec 112801*/
    :root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}
header{display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;align-items:stretch;}
.title{background:#e8f7ee;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;padding:12px;}
.title h1{margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;}
.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;font-weight:700;}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}
.source-note {
  font-size: 50%; 
  color: #444;
  font-weight: 500;
  margin-left: 4px;
}

/* ä¸Šæ–¹å…©å€‹é¢æ¿ */
.top-panels{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap);}
.panel{background:#fff;border:4px solid var(--panel);border-radius:var(--radius);padding:12px;}
.panel h2{margin:0 0 8px 0;font-size:28px}

/* å¤©æ°£ */
.weather-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;background:var(--tile);
  border-radius:14px;padding:12px;align-items:start;justify-items:start;}
.weather-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;line-height:1.4}
.weather-cell img{width:36px;height:36px;}

/* ç’°å¢ƒæ„Ÿæ¸¬ */
.env-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--tile);
  border-radius:14px;padding:12px;align-items:center;justify-items:center;}
.env-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;color:var(--num);}
.env-cell img{width:50px;height:50px;}
.env-cell .value{font-size:36px;font-weight:800}

/* è¡¨æ ¼ */
.table-wrap{margin-top:var(--gap);background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px}
.table-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
.table-title h3{margin:0;font-size:26px}

/* çµ±ä¸€æŒ‰éˆ• */
.btn{
  background:var(--panel);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:10px 0;
  width:130px;
  font-size:20px;
  font-weight:800;
  cursor:pointer;
  letter-spacing:1px;
  text-align:center;
}
.btn:active{transform:translateY(1px);}
.depth-btn.active{background:var(--ok);}

table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{font-size:18px;color:#334155;text-align:center}
tbody td,thead th{padding:10px 8px}
tbody tr{background:var(--tile);}
tbody tr td{font-size:22px;text-align:center;font-weight:700;color:var(--num)}
tbody tr td:first-child{font-weight:800;color:#1f2937}

/* footer */
.footer-line{color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;}

/* æ‰‹æ©Ÿ */
@media (max-width:768px){
  header{grid-template-columns:1fr !important;}
  .title h1{font-size:32px}
  .clock{font-size:32px}
  .datebox{font-size:24px}
  .top-panels{grid-template-columns:1fr;}
  .env-grid{grid-template-columns:1fr;}
  tbody tr td{font-size:18px}
  .table-title {flex-direction:column;align-items:center;gap:12px;}
  .depth-buttons {
    display:grid;grid-template-columns:repeat(2,1fr);
    gap:10px 14px;justify-items:center;
  }
  .btn{width:120px;font-size:18px;}
}
/* ===== é›»è…¦ç‰ˆï¼šå…¨éƒ¨é å·¦ã€åŒä¸€è¡Œ ===== */
.weather-title {
  display: flex;
  align-items: center;
  gap: 8px;     /* â† è®“å…©è€…ä¸è¦è²¼å¤ªè¿‘ */
  font-size: 28px;
}

.wt-left {
  font-weight: 700;
}

.wt-right {
  font-size: 60%;
  color: #444;
  font-weight: 500;
  white-space: nowrap;
}


/* ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šä¾†æºç§»åˆ°ç¬¬äºŒè¡Œ + é å³ */
@media (max-width: 600px) {
  .weather-title {
    flex-wrap: wrap;            /* å…è¨±æ›è¡Œ */
  }

  .wt-right {
    width: 100%;                /* è®“å®ƒå ä¸€è¡Œ */
    text-align: right;          /* é å³ */
    margin-top: 4px;
  }
}


/* ===== æ•¸æ“šé¡è‰²ç³»çµ± ===== */
.val-ok { color:#0f9d58 !important; font-weight:900; }
.val-warn { color:#f4b400 !important; font-weight:900; }
.val-bad { color:#db4437 !important; font-weight:900; }
.val-high { color:#c71585 !important; font-weight:900; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="datebox" id="dateBox">--</div>
    <div class="title"><h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1><small>Real-time Dashboard</small></div>
    <div class="clock"><div id="mainClock">00:00:00</div></div>
  </header>

  <!-- ============================= -->
  <!--          å¤©æ°£é¢æ¿            -->
  <!-- ============================= -->
  <div class="top-panels">
    <section class="panel">
<h2 class="weather-title">
  <span class="wt-left">å—æŠ• åé–“é„‰å¤©æ°£ç‹€æ³</span>
  <span class="wt-right">(è³‡æ–™ä¾†æºï¼šæ°£è±¡ç½²)</span>
</h2>
      <div class="weather-grid">
        <div class="weather-cell"><img id="weatherIcon" src=""><span>å¤©æ°£ï¼š<span id="weatherDesc">â€”</span></span></div>
        <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><span>æ°£æº«ï¼š<span id="weatherTemp">â€”</span> Â°C</span></div>
        <div class="weather-cell"><img src="https://img.icons8.com/color/48/humidity.png"><span>æ¿•åº¦ï¼š<span id="weatherHumi">â€”</span> %</span></div>
        <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/umbrella-with-rain-drops.png"><span>é™é›¨é‡ï¼š<span id="rainfall">â€”</span> mm</span></div>
      </div>
    </section>

    <section class="panel">
      <h2>èŒ¶åœ’æº«æº¼åº¦æ„Ÿæ¸¬å™¨</h2>
      <div class="env-grid">
        <div class="env-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png"><div><span>æº«åº¦</span><br><span class="value" id="envTemp">â€”</span></div></div>
        <div class="env-cell"><img src="https://img.icons8.com/color/48/humidity.png"><div><span>æ¿•åº¦</span><br><span class="value" id="envHumi">â€”</span></div></div>
      </div>
    </section>
  </div>

  <!-- ============================= -->
  <!--     åœŸå£¤è³‡æ–™ + é¡è‰²è®ŠåŒ–      -->
  <!-- ============================= -->
<!-- ============================= -->
<!--     åœŸå£¤è³‡æ–™ + é¡è‰²è®ŠåŒ–      -->
<!-- ============================= -->
<section class="table-wrap">
  <div class="table-title">
    <h3>å„ç«™åœŸå£¤æ•¸æ“š</h3>

    <div class="depth-buttons"> 
      <button class="btn depth-btn active" data-depth="Surface">è¡¨é¢å±¤</button>
      <button class="btn depth-btn" data-depth="15cm">15 cm å±¤</button>
      <button class="btn depth-btn" data-depth="25cm">25 cm å±¤</button>
      <button class="btn" id="btnFullscreen">å…¨è¢å¹•</button>
      <button class="btn" id="btnNotify">ğŸ”” é€šçŸ¥æ¸¬è©¦</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>é …ç›®</th><th>æº«åº¦ (Â°C)</th><th>å«æ°´ç‡ (%)</th>
        <th>æ°® (N)</th><th>ç£· (P)</th><th>é‰€ (K)</th>
      </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>

  <div class="footer-line" id="footerInfo">
    æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼šâ€”ã€€ï½œã€€æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼šâ€”ã€€ï½œã€€ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼šâ€”
  </div>
</section>   <!-- â† æ­£ç¢ºçµå°¾ -->


<script>
/* ================================ */
/*           åŸºæœ¬è¨­å®š               */
/* ================================ */
/* ================================ */
/*        ğŸ”” ç¶²é é€šçŸ¥åŠŸèƒ½           */
/* ================================ */
async function sendNotification(title, body) {
  // è‹¥ä½¿ç”¨è€…å°šæœªå…è¨±é€šçŸ¥ â†’ å…ˆè¦æ±‚æ¬Šé™
  if (Notification.permission !== "granted") {
    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("æ‚¨å°šæœªé–‹å•Ÿé€šçŸ¥æ¬Šé™");
      return;
    }
  }

  // ç™¼é€é€šçŸ¥
  new Notification(title, {
    body: body,
    icon: "https://img.icons8.com/color/96/tea.png"
  });
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("btnNotify").addEventListener("click", () => {

  // A. ç¶²é é€šçŸ¥
  sendNotification("ç‘æˆæ™ºæ…§èŒ¶åœ’é€šçŸ¥", "è³‡æ–™æ›´æ–°å®Œæˆï¼ï¼ˆå« LINE æ¸¬è©¦ï¼‰");

  // B. LINE æ¨æ’­
  sendLineNotify();
});





const CONFIG = {
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};

function pad(n){return n<10?'0'+n:n}
function nowStr(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
function dateStr(){const d=new Date();const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰` }
function roundInt(x){if(x==null||x==='')return'â€”';const n=Number(x);return isFinite(n)?Math.round(n):String(x);}


/* ================================ */
/*        æ•¸å€¼ â†’ é¡è‰²åˆ¤æ–·           */
/* ================================ */
function colorClass(type, value){
  if(value === "â€”" || value === "" || value == null) return "";
  value = Number(value);

  switch(type){
    case "temp":
      if(value < 10) return "val-warn";
      if(value < 28) return "val-ok";
      if(value < 35) return "val-warn";
      return "val-bad";

    case "moist":
      if(value < 20) return "val-bad";
      if(value < 35) return "val-warn";
      if(value < 70) return "val-ok";
      return "val-warn";

    case "n":
    case "p":
    case "k":
      if(value === 0) return "val-bad";
      if(value < 20) return "val-warn";
      return "val-ok";

    default: return "";
  }
}


/* ================================ */
/*            æ›´æ–°è¡¨æ ¼              */
/* ================================ */
let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes*60;
const footer=document.getElementById("footerInfo");

function updateFooter(){
  const m=Math.floor(remainingSec/60), s=pad(remainingSec%60);
  footer.textContent = `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime}ã€€ï½œã€€æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime}ã€€ï½œã€€ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now(),{cache:'no-store'});
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(',').map(v=>v.replace(/^"|"$/g,'').trim()));
  const cols=lines[0].map(c=>c.replace(/^\uFEFF/,'').trim());
  const rows=lines.slice(1);
  return {cols,rows};
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--) if(rows[i].some(v=>v!=="")) return rows[i];
  return null;
}

async function refreshSheet(depth="Surface"){
  try{
    const {cols, rows} = await fetchCSV();
    const last = getLastValid(rows);
    if(!last) return;

    const timeIdx = cols.findIndex(c=>c.toLowerCase().includes("time"));
    genTime = timeIdx>=0 ? last[timeIdx] : "â€”";
    updateFooter();

    const idx={}; cols.forEach((c,i)=>idx[c.toLowerCase()]=i);

    document.getElementById("envTemp").textContent = roundInt(last[idx["teagarden_air_temp"]]);
    document.getElementById("envHumi").textContent = roundInt(last[idx["teagarden_air_humidity"]]);

    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    for(let s=1;s<=CONFIG.stationCount;s++){
      const p=`station${s}_${depth.toLowerCase()}`;

      const soilTemp = roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist = roundInt(last[idx[`${p}_soilmoisture`]]);
      const nitrogen = roundInt(last[idx[`${p}_nitrogen`]]);
      const phosphorus = roundInt(last[idx[`${p}_phosphorus`]]);
      const potassium = roundInt(last[idx[`${p}_potassium`]]);
// â­ AI é€šçŸ¥è§¸ç™¼ï¼ˆä¸€å®šè¦åŠ ï¼‰
checkMoisture(s, soilMoist);
checkNPK(s, nitrogen, phosphorus, potassium);
checkSoilTemp(s, soilTemp);
      const tr=document.createElement("tr");
      tr.innerHTML = `
      <td>ç¬¬${s}ç«™</td>
      <td class="${colorClass('temp', soilTemp)}">${soilTemp}</td>
      <td class="${colorClass('moist', soilMoist)}">${soilMoist}</td>
      <td class="${colorClass('n', nitrogen)}">${nitrogen}</td>
      <td class="${colorClass('p', phosphorus)}">${phosphorus}</td>
      <td class="${colorClass('k', potassium)}">${potassium}</td>
      `;
      tbody.appendChild(tr);
    }

  }catch(e){ console.warn("CSV éŒ¯èª¤ï¼š",e); }
}

/* ============================================
   ğŸŒŸ ç‘æˆæ™ºæ…§èŒ¶åœ’ AI é€šçŸ¥ç³»çµ± v1.0
   ============================================ */

// é˜²æ­¢åŒä¸€æ¢é€šçŸ¥ä¸€ç›´è·³
let notified = {
  moisture: {},
  npk: {},
  temp: {},
  weather: false,
  offline: false
};

// è§¸ç™¼é€šçŸ¥ç”¨
function alertTea(title, msg) {
  sendNotification(title, msg);
  console.log("[é€šçŸ¥] ", title, msg);
}

/* ============================================
   ğŸ“Œ 1. åœŸå£¤å«æ°´ç‡ç•°å¸¸
   ============================================ */
function checkMoisture(station, value) {
  if (value < 20 && !notified.moisture[station]) {
    alertTea(
      "åœŸå£¤å«æ°´ç‡åä½",
      `ç¬¬ ${station} ç«™å«æ°´ç‡åƒ… ${value}% ï¼Œå¯èƒ½åä¹¾ç‡¥`
    );
    notified.moisture[station] = true;
  }
}

/* ============================================
   ğŸ“Œ 2. NPK ç•°å¸¸ï¼ˆ0 or <20ï¼‰
   ============================================ */
function checkNPK(station, n, p, k) {
  if (n === 0 && !notified.npk[station + "_n"]) {
    alertTea("N æ°®å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ æ°®(N)=0ï¼Œè«‹æª¢æŸ¥æ„Ÿæ¸¬å™¨`);
    notified.npk[station + "_n"] = true;
  }
  if (p === 0 && !notified.npk[station + "_p"]) {
    alertTea("P ç£·å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ ç£·(P)=0ï¼Œè«‹æª¢æŸ¥æ„Ÿæ¸¬å™¨`);
    notified.npk[station + "_p"] = true;
  }
  if (k === 0 && !notified.npk[station + "_k"]) {
    alertTea("K é‰€å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ é‰€(K)=0ï¼Œè«‹æª¢æŸ¥æ„Ÿæ¸¬å™¨`);
    notified.npk[station + "_k"] = true;
  }
}

/* ============================================
   ğŸ“Œ 3. åœŸå£¤æº«åº¦ç•°å¸¸
   ============================================ */
function checkSoilTemp(station, value) {
  if (value > 35 && !notified.temp[station]) {
    alertTea("åœŸå£¤æº«åº¦éé«˜", `ç¬¬ ${station} ç«™åœŸå£¤æº«åº¦ ${value}Â°C`);
    notified.temp[station] = true;
  }
  if (value < 10 && !notified.temp[station + "_low"]) {
    alertTea("åœŸå£¤éå†·", `ç¬¬ ${station} ç«™åœŸå£¤åƒ… ${value}Â°C`);
    notified.temp[station + "_low"] = true;
  }
}

/* ============================================
   ğŸ“Œ 4. å¤©æ°£é–‹å§‹ä¸‹é›¨ï¼ˆä¸€æ¬¡æ€§é€šçŸ¥ï¼‰
   ============================================ */
function checkRain(value) {
  if (value > 0 && !notified.weather) {
    alertTea("ğŸŒ§ é–‹å§‹ä¸‹é›¨", `åé–“é„‰é™é›¨é‡ï¼š${value} mm`);
    notified.weather = true;
  }
}

/* ============================================
   ğŸ“Œ 5. æ„Ÿæ¸¬å™¨å¯èƒ½æ‰ç·šï¼ˆOffline Detectionï¼‰
   --------------------------------------------
   ğŸ”§ ä¸»è¦åƒæ•¸ï¼ˆå¯è‡ªç”±èª¿æ•´ï¼‰
   - OFFLINE_LIMIT = 10 * 60 * 1000   â†’ 10åˆ†é˜ï¼ˆæ¯«ç§’ï¼‰
   - CHECK_INTERVAL = 10 * 1000       â†’ æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
   ============================================ */

// â— æ¯ç­†è³‡æ–™æ›´æ–°æ™‚ï¼ŒrefreshSheet() æœƒæ›´æ–°æ­¤æ™‚é–“
let lastUpdateTime = Date.now(); 

// ğŸ”§ã€è¨­å®šæ‰ç·šåˆ¤æ–·æ™‚é–“ã€‘
// 10 åˆ†é˜ = 10 * 60 * 1000 æ¯«ç§’
const OFFLINE_LIMIT = 10 * 60 * 1000;   // â† ä½ å¯ä»¥æ”¹é€™è£¡ï¼ˆæ¯«ç§’ï¼‰

// ğŸ”§ã€è¨­å®šå¤šä¹…æª¢æŸ¥ä¸€æ¬¡ã€‘
// ç›®å‰ï¼š10 ç§’æª¢æŸ¥ä¸€æ¬¡
const CHECK_INTERVAL = 10 * 1000;       // â† ä½ å¯ä»¥æ”¹é€™è£¡ï¼ˆæ¯«ç§’ï¼‰

function checkOffline() {
  // å¦‚æœå°šæœªé€šçŸ¥éï¼Œä¸”è·é›¢ä¸Šæ¬¡è³‡æ–™æ›´æ–°æ™‚é–“å·²è¶…éè¨­å®šç§’æ•¸
  if (!notified.offline &&
      Date.now() - lastUpdateTime > OFFLINE_LIMIT) {

    alertTea(
      "âš  æ„Ÿæ¸¬å™¨æ‰ç·š",
      `è¶…é ${(OFFLINE_LIMIT / 60000).toFixed(1)} åˆ†é˜æœªæ”¶åˆ°è³‡æ–™æ›´æ–°`
    );

    notified.offline = true;
  }
}

// â± æ¯ CHECK_INTERVAL æ¯«ç§’æª¢æŸ¥ä¸€æ¬¡
setInterval(checkOffline, CHECK_INTERVAL);


/* ============================================
   ğŸ‘‡ æ•´åˆåˆ° refreshSheet()ï¼ˆä½ éœ€åŠ å…¥é€™è£¡ï¼‰
   ============================================ */

// è«‹åœ¨ refreshSheet() è£¡æ¯ç«™è³‡æ–™è™•ç†å¾ŒåŠ å…¥ï¼š

// checkMoisture(stationNum, soilMoist);
// checkNPK(stationNum, nitrogen, phosphorus, potassium);
// checkSoilTemp(stationNum, soilTemp);





    

/* ================================ */
/*             å¤©æ°£ API            */
/* ================================ */
async function refreshWeather(){
  try{
    const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;
    const res=await fetch(url);
    const js=await res.json();
    const st=js.records?.Station?.[0];
    const w=st?.WeatherElement||{};

    document.getElementById("weatherDesc").textContent=w.Weather||"â€”";
    document.getElementById("weatherTemp").textContent=roundInt(w.AirTemperature);
    document.getElementById("weatherHumi").textContent=roundInt(w.RelativeHumidity);
    document.getElementById("rainfall").textContent=roundInt(w.Now?.Precipitation);

    document.getElementById("weatherIcon").src =
      w.Weather?.includes("é›¨")
      ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
      : "https://img.icons8.com/emoji/48/sun-emoji.png";

    weatherTime = (st?.ObsTime?.DateTime||"").replace("T"," ").slice(0,19) || "â€”";
    updateFooter();

  }catch(e){
    console.warn("æ°£è±¡éŒ¯èª¤:", e);
  }
}


/* ================================ */
/*       æŒ‰éˆ•ã€å€’æ•¸ã€æ™‚é˜           */
/* ================================ */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    refreshSheet(btn.getAttribute("data-depth"));
  });
});

document.getElementById("btnFullscreen").onclick=()=>document.documentElement.requestFullscreen?.();

/* æ™‚é˜ */
(function clockTick(){
  document.getElementById("mainClock").textContent=nowStr();
  document.getElementById("dateBox").textContent=dateStr();
  requestAnimationFrame(()=>setTimeout(clockTick,250));
})();

/* å€’æ•¸ */
setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0){
    location.replace(location.href.split("?")[0]+"?t="+Date.now());
    return;
  }
  updateFooter();
},1000);
/* ================================
   ğŸ”” LINE æ¨æ’­åŠŸèƒ½ï¼ˆWeb â†’ GASï¼‰
   ================================ */
/* ================================
   ğŸ”” LINE ç¾¤ç™¼æ¨æ’­åŠŸèƒ½ï¼ˆWeb â†’ GASï¼‰
   ================================ */
function sendLineNotify() {
  fetch("https://script.google.com/macros/s/AKfycbxAddWYDCtxiFcyOdZqYvVzzNwt-Dp8_eYYkgLhNd_sUEMMnfly2GAq6Vi2C4ivww0z/exec", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `title=ğŸ”” ç¾¤ç™¼é€šçŸ¥&message=é€™æ˜¯ä¾†è‡ªæ™ºæ…§èŒ¶åœ’å„€è¡¨æ¿çš„ç¾¤ç™¼ LINE æ¸¬è©¦é€šçŸ¥ï¼`
  })
  .then(r => r.text())
  .then(txt => console.log("[LINE ç¾¤ç™¼æˆåŠŸ]", txt))
  .catch(err => console.error("[LINE ç¾¤ç™¼éŒ¯èª¤]", err));
}



/* åˆå§‹åŒ– */
refreshSheet();
refreshWeather();
</script>



<!-- Dialogflow -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
<df-messenger
  intent="WELCOME"
  chat-title="ç‘æˆèŒ¶åœ’æ™ºæ…§åŠ©æ‰‹"
  agent-id="8b30913c-be1a-4cd9-9309-136c81726d04"
  language-code="zh-tw"
></df-messenger>



</body>

</html>  
