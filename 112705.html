<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‘æˆæ™ºæ…§èŒ¶åœ’ - å³æ™‚å„€è¡¨æ¿ v7.2</title>

<style>
:root{
  --bg:#CDEDC7;
  --panel:#245953;
  --tile:#E7F6E7;
  --text:#0B2D2A;
  --num:#0f172a;
  --ok:#16a34a;
  --radius:18px;
  --gap:14px;
}
html,body{
  height:100%;margin:0;background:var(--bg);
  font-family:"Microsoft JhengHei",system-ui,sans-serif;color:var(--text);
}
.wrap{max-width:1280px;margin:auto;padding:18px;}

/* ===== æ¨™é ­å€ ===== */
header{
  display:grid;gap:var(--gap);
  grid-template-columns:1.2fr 1fr 1.2fr;align-items:stretch;
}
.title{
  background:#e8f7ee;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;padding:12px;
}
.title h1{margin:6px 0 2px 0;font-size:44px;letter-spacing:4px;}
.clock,.datebox{
  background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);display:flex;align-items:center;
  justify-content:center;flex-direction:column;font-weight:700;}
.clock{font-size:46px;}
.datebox{font-size:36px;font-weight:800;}
.source-note {font-size:50%;color:#444;margin-left:4px;}

/* ä¸Šæ–¹å…©å€‹é¢æ¿ */
.top-panels{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap);}
.panel{background:#fff;border:4px solid var(--panel);border-radius:var(--radius);padding:12px;}
.panel h2{margin:0 0 8px 0;font-size:28px}

/* å¤©æ°£ */
.weather-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.weather-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700}
.weather-cell img{width:36px;height:36px}

/* ç’°å¢ƒæ„Ÿæ¸¬ */
.env-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--tile);
  border-radius:14px;padding:12px;}
.env-cell{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;color:var(--num);}
.env-cell img{width:50px;height:50px;}
.env-cell .value{font-size:36px;font-weight:800}

/* è¡¨æ ¼ */
.table-wrap{margin-top:var(--gap);background:#fff;border:4px solid var(--panel);
  border-radius:var(--radius);padding:14px}
.table-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
.table-title h3{margin:0;font-size:26px}

/* çµ±ä¸€æŒ‰éˆ• */
.btn{
  background:var(--panel);
  color:#fff;border:none;border-radius:999px;
  padding:10px 0;width:130px;font-size:20px;font-weight:800;
  cursor:pointer;letter-spacing:1px;text-align:center;
}
.btn:active{transform:translateY(1px);}
.depth-btn.active{background:var(--ok);}

/* è¡¨æ ¼ */
table{width:100%;border-collapse:separate;border-spacing:0 10px;}
thead th{font-size:18px;color:#334155;text-align:center}
tbody tr{background:var(--tile);}
tbody tr td{font-size:22px;text-align:center;font-weight:700;color:var(--num)}
tbody tr td:first-child{font-weight:800;color:#1f2937}

/* footer */
.footer-line{color:#2563eb;font-size:15px;margin-top:10px;text-align:center;
  border-top:2px solid #a3bfa3;padding-top:6px;}

/* æ‰‹æ©Ÿ */
@media (max-width:768px){
  header{grid-template-columns:1fr !important;}
  .title h1{font-size:32px}
  .clock{font-size:32px}
  .datebox{font-size:24px}
  .top-panels{grid-template-columns:1fr;}
  .env-grid{grid-template-columns:1fr;}
  tbody tr td{font-size:18px}
  .table-title {flex-direction:column;align-items:center;gap:12px;}
  .depth-buttons {display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
  .btn{width:120px;font-size:18px;}
}

/* é¡è‰²ç³»çµ± */
.val-ok { color:#0f9d58 !important; font-weight:900; }
.val-warn { color:#f4b400 !important; font-weight:900; }
.val-bad { color:#d93025 !important; font-weight:900; }
.val-high { color:#c71585 !important; font-weight:900; }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="datebox" id="dateBox">--</div>
    <div class="title"><h1>ç‘æˆæ™ºæ…§èŒ¶åœ’</h1><small>Real-time Dashboard</small></div>
    <div class="clock"><div id="mainClock">00:00:00</div></div>
  </header>

  <!-- å¤©æ°£ -->
  <div class="top-panels">
    <section class="panel">
      <h2>å—æŠ• åé–“é„‰å¤©æ°£ç‹€æ³ <small class="source-note">ï¼ˆè³‡æ–™ä¾†æºï¼šæ°£è±¡ç½²ï¼‰</small></h2>
      <div class="weather-grid">
        <div class="weather-cell"><img id="weatherIcon"><span>å¤©æ°£ï¼š<span id="weatherDesc">â€”</span></span></div>
        <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/thermometer-emoji.png">æ°£æº«ï¼š<span id="weatherTemp">â€”</span>Â°C</div>
        <div class="weather-cell"><img src="https://img.icons8.com/color/48/humidity.png">æ¿•åº¦ï¼š<span id="weatherHumi">â€”</span>%</div>
        <div class="weather-cell"><img src="https://img.icons8.com/emoji/48/umbrella-with-rain-drops.png">é™é›¨ï¼š<span id="rainfall">â€”</span> mm</div>
      </div>
    </section>

    <!-- èŒ¶åœ’ç’°å¢ƒ -->
    <section class="panel">
      <h2>èŒ¶åœ’æº«æº¼åº¦æ„Ÿæ¸¬å™¨</h2>
      <div class="env-grid">
        <div class="env-cell">
          <img src="https://img.icons8.com/emoji/48/thermometer-emoji.png">
          <div><span>æº«åº¦</span><br><span class="value" id="envTemp">â€”</span></div>
        </div>
        <div class="env-cell">
          <img src="https://img.icons8.com/color/48/humidity.png">
          <div><span>æ¿•åº¦</span><br><span class="value" id="envHumi">â€”</span></div>
        </div>
      </div>
    </section>
  </div>

  <!-- åœŸå£¤è³‡æ–™ -->
  <div class="table-wrap">
    <div class="table-title">
      <h3>å„ç«™åœŸå£¤æ•¸æ“š</h3>
      <div class="depth-buttons">
        <button class="btn depth-btn active" data-depth="Surface">è¡¨é¢å±¤</button>
        <button class="btn depth-btn" data-depth="15cm">15cm å±¤</button>
        <button class="btn depth-btn" data-depth="25cm">25cm å±¤</button>
        <button class="btn" id="btnFullscreen">å…¨è¢å¹•</button>
        <button class="btn" id="btnNotify">ğŸ”” é€šçŸ¥æ¸¬è©¦</button>
      </div>
    </div>

    <table>
      <thead><tr><th>é …ç›®</th><th>æº«åº¦</th><th>å«æ°´ç‡</th><th>N</th><th>P</th><th>K</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer-line" id="footerInfo">
      æ°£è±¡ç«™ï¼šâ€” ï½œ æ„Ÿæ¸¬å™¨ï¼šâ€” ï½œ ğŸ”„ å€’æ•¸ï¼šâ€”
    </div>
  </div>
</div>

<script>
/* ------------------------------
   è¨­å®šå€
-------------------------------- */
const GAS_PUSH_URL = "https://script.google.com/macros/s/AKfycbwN1KxcZiVb7qJxciLskIzDSB06-Z1KJNGo4BsNJh3wgqd9xAoYF-_1lm0W4RgNPeYPRw/exec";

const CONFIG = {
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};

function pad(n){return n<10?'0'+n:n}
function nowStr(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`}
function dateStr(){const d=new Date();const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰`}
function roundInt(x){if(x==null||x==='')return'â€”';const n=Number(x);return isFinite(n)?Math.round(n):String(x);}

/* ------------------------------
   é€šçŸ¥ï¼ˆç€è¦½å™¨ + LINEï¼‰
-------------------------------- */
async function pushLine(title, message){
  try{
    await fetch(GAS_PUSH_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ title, message })
    });
  }catch(e){ console.error("LINE æ¨æ’­å¤±æ•—ï¼š",e); }
}

async function browserNotify(title, body){
  if(Notification.permission!=="granted"){
    let p=await Notification.requestPermission();
    if(p!=="granted"){ alert("è«‹å…è¨±é€šçŸ¥æ¬Šé™");return; }
  }
  new Notification(title,{ body, icon:"https://img.icons8.com/color/96/tea.png" });
}

function alertTea(title,msg){
  browserNotify(title,msg);
  pushLine(title,msg);
}

/* æŒ‰éˆ•ï¼šæ‰‹å‹•é€šçŸ¥ */
/* æŒ‰éˆ•ï¼šæ‰‹å‹•é€šçŸ¥ */
document.getElementById("btnNotify").onclick = () => {

  // 1ï¸âƒ£ ç€è¦½å™¨é€šçŸ¥
  alertTea("ç‘æˆæ™ºæ…§èŒ¶åœ’é€šçŸ¥", "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥ï¼ˆLINE + ç€è¦½å™¨ï¼‰");

  // 2ï¸âƒ£ LINE æ¨æ’­ï¼ˆMessaging API GASï¼‰
  fetch("https://script.google.com/macros/s/AKfycbwN1KxcZiVb7qJxciLskIzDSB06-Z1KJNGo4BsNJh3wgqd9xAoYF-_1lm0W4RgNPeYPRw/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: "ğŸ”” æ¸¬è©¦ï¼šMessaging API å·²æˆåŠŸé€£ç·š",
      message: "é€™æ˜¯ä¸€å‰‡æŒ‰éˆ•è§¸ç™¼çš„æ¸¬è©¦è¨Šæ¯ï¼ï¼ˆä¾†è‡ª HTML é é¢ï¼‰"
    })
  })
  .then(r => r.text())
  .then(res => console.log("LINE æ¨æ’­å›æ‡‰ï¼š", res))
  .catch(err => console.error("LINE æ¨æ’­å¤±æ•—ï¼š", err));
};


/* ------------------------------
   æ¬„ä½é¡è‰²
-------------------------------- */
function colorClass(type, value){
  if(value=="â€”") return "";
  value=Number(value);

  if(type=="temp"){
    if(value<10) return"val-warn";
    if(value<28) return"val-ok";
    if(value<35) return"val-warn";
    return"val-bad";
  }
  if(type=="moist"){
    if(value<20) return"val-bad";
    if(value<35) return"val-warn";
    if(value<70) return"val-ok";
    return"val-warn";
  }
  if(type=="n"||type=="p"||type=="k"){
    if(value==0) return"val-bad";
    if(value<20) return"val-warn";
    return"val-ok";
  }
  return"";
}

/* ------------------------------
   è®€ CSV
-------------------------------- */
async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now());
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(r=>r.split(',').map(v=>v.replace(/^"|"$/g,'').trim()));
  const cols=lines[0].map(c=>c.toLowerCase());
  return { cols, rows:lines.slice(1) };
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--) if(rows[i].some(v=>v!="")) return rows[i];
  return null;
}

/* ------------------------------
   å‘Šè­¦ç³»çµ±
-------------------------------- */
let lastUpdateTime=Date.now();
let notified={ moisture:{}, npk:{}, temp:{}, weather:false, offline:false };
let genTime="â€”", weatherTime="â€”";

function checkOffline(){
  if(!notified.offline && Date.now()-lastUpdateTime>30000){
    alertTea("âš  æ„Ÿæ¸¬å™¨å¯èƒ½æ‰ç·š","30 ç§’æœªæ”¶åˆ°è³‡æ–™æ›´æ–°");
    notified.offline=true;
  }
}
setInterval(checkOffline,10000);

/* ------------------------------
   æ›´æ–°è¡¨æ ¼
-------------------------------- */
async function refreshSheet(depth="Surface"){
  try{
    const {cols, rows}=await fetchCSV();
    const last=getLastValid(rows);
    if(!last) return;

    lastUpdateTime=Date.now();

    const idx={}; cols.forEach((c,i)=>idx[c]=i);

    genTime=last[idx["time"]] || "â€”";

    document.getElementById("envTemp").textContent=roundInt(last[idx["teagarden_air_temp"]]);
    document.getElementById("envHumi").textContent=roundInt(last[idx["teagarden_air_humidity"]]);

    const depthKey=depth.toLowerCase();
    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    for(let s=1;s<=CONFIG.stationCount;s++){
      const p=`station${s}_${depthKey}`;
      const soilTemp=roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist=roundInt(last[idx[`${p}_soilmoisture`]]);
      const n=roundInt(last[idx[`${p}_nitrogen`]]);
      const p2=roundInt(last[idx[`${p}_phosphorus`]]);
      const k=roundInt(last[idx[`${p}_potassium`]]);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>ç¬¬${s}ç«™</td>
        <td class="${colorClass("temp",soilTemp)}">${soilTemp}</td>
        <td class="${colorClass("moist",soilMoist)}">${soilMoist}</td>
        <td class="${colorClass("n",n)}">${n}</td>
        <td class="${colorClass("p",p2)}">${p2}</td>
        <td class="${colorClass("k",k)}">${k}</td>
      `;
      tbody.appendChild(tr);
    }
  }catch(e){
    console.error("CSV éŒ¯èª¤:",e);
  }
}

/* ------------------------------
   å¤©æ°£
-------------------------------- */
async function refreshWeather(){
  try{
    const URL=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;
    const js=await (await fetch(URL)).json();
    const st=js.records?.Station?.[0];
    if(!st)return;

    const w=st.WeatherElement;

    const rain=roundInt(w.Now.Precipitation);
    const temp=roundInt(w.AirTemperature);
    const humi=roundInt(w.RelativeHumidity);

    document.getElementById("weatherDesc").textContent=w.Weather;
    document.getElementById("weatherTemp").textContent=temp;
    document.getElementById("weatherHumi").textContent=humi;
    document.getElementById("rainfall").textContent=rain;

    document.getElementById("weatherIcon").src =
      (w.Weather||"").includes("é›¨")
      ? "https://img.icons8.com/emoji/48/cloud-with-rain.png"
      : "https://img.icons8.com/emoji/48/sun-emoji.png";

    weatherTime = st.ObsTime.DateTime.replace("T"," ").slice(0,19);

  }catch(e){
    console.error("å¤©æ°£éŒ¯èª¤:",e);
  }
}

/* ------------------------------
   åˆ‡æ›å±¤ç´šæŒ‰éˆ•
-------------------------------- */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    refreshSheet(btn.dataset.depth);
  };
});

/* ------------------------------
   å…¨è¢å¹•
-------------------------------- */
document.getElementById("btnFullscreen").onclick=
  ()=>document.documentElement.requestFullscreen();

/* ------------------------------
   æ™‚é˜ + å€’æ•¸
-------------------------------- */
let remainingSec=CONFIG.autoRefreshMinutes*60;

setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0) location.reload();
  document.getElementById("footerInfo").textContent =
    `æ°£è±¡ç«™ï¼š${weatherTime} ï½œ æ„Ÿæ¸¬å™¨ï¼š${genTime} ï½œ ğŸ”„ å€’æ•¸ï¼š${Math.floor(remainingSec/60)}:${pad(remainingSec%60)}`;
},1000);

(function clockTick(){
  document.getElementById("mainClock").textContent=nowStr();
  document.getElementById("dateBox").textContent=dateStr();
  requestAnimationFrame(()=>setTimeout(clockTick,250));
})();

/* ------------------------------
   åˆå§‹åŒ–
-------------------------------- */
refreshSheet("Surface");
refreshWeather();
</script>

<!-- Dialogflow -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
<df-messenger
  intent="WELCOME"
  chat-title="ç‘æˆèŒ¶åœ’æ™ºæ…§åŠ©æ‰‹"
  agent-id="8b30913c-be1a-4cd9-9309-136c81726d04"
  language-code="zh-tw">
</df-messenger>

</body>
</html>
