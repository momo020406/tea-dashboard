<script>
/* ================================ */
/*           åŸºæœ¬è¨­å®š               */
/* ================================ */

/* âœˆ Telegram æ¨æ’­ï¼ˆå”¯ä¸€é€šçŸ¥ç³»çµ±ï¼‰ */
const TG_TOKEN = "8401721166:AAElCyyE-Ik-QZP3l1l2YNl1-_fdHp6HEq0";
const TG_CHAT_ID = "7660987483";

function sendTelegram(title, message) {
  const text = `ã€${title}ã€‘\n${message}`;

  return fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: TG_CHAT_ID, text })
  })
  .then(r => r.json())
  .then(r => console.log("[Telegram]", r))
  .catch(err => console.error("[TG Error]", err));
}

/* é€šçŸ¥æŒ‰éˆ•ï¼ˆåªç”¨ Telegramï¼‰ */
document.getElementById("btnNotify").addEventListener("click", () => {
  sendTelegram("ğŸ”” æ¸¬è©¦é€šçŸ¥", "é€™æ˜¯ä¸€å‰‡ Telegram æ¸¬è©¦è¨Šæ¯ï¼");
});


const CONFIG = {
  sheetCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7HeQa-EF65JqRoZufcn3U6msKU7NSr0QqPezgqcuCHousSsK8z_IBHkdGvLNU0XZTcreLfnBwL0M/pub?output=csv",
  cwaAuth:"CWA-4A8A0D9D-95EA-4DA0-A62C-2DC7A8909F06",
  cwaStation:"C0I410",
  autoRefreshMinutes:1,
  stationCount:4
};


function pad(n){return n<10?'0'+n:n}
function nowStr(){const d=new Date();return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}` }
function dateStr(){const d=new Date();const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}ï¼ˆé€±${w}ï¼‰` }
function roundInt(x){if(x==null||x==='')return'â€”';const n=Number(x);return isFinite(n)?Math.round(n):String(x);}


/* ========== é¡è‰²ç³»çµ± ========== */
function colorClass(type, value){
  if(value === "â€”" || value === "" || value == null) return "";
  value = Number(value);

  switch(type){
    case "temp":
      if(value < 10) return "val-warn";
      if(value < 28) return "val-ok";
      if(value < 35) return "val-warn";
      return "val-bad";

    case "moist":
      if(value < 20) return "val-bad";
      if(value < 35) return "val-warn";
      if(value < 70) return "val-ok";
      return "val-warn";

    case "n":
    case "p":
    case "k":
      if(value === 0) return "val-bad";
      if(value < 20) return "val-warn";
      return "val-ok";

    default: return "";
  }
}


/* ================================ */
/*            æ›´æ–°è¡¨æ ¼              */
/* ================================ */
let weatherTime="â€”", genTime="â€”";
let remainingSec = CONFIG.autoRefreshMinutes*60;
const footer=document.getElementById("footerInfo");

function updateFooter(){
  const m=Math.floor(remainingSec/60), s=pad(remainingSec%60);
  footer.textContent = `æ°£è±¡ç«™æ›´æ–°æ™‚é–“ï¼š${weatherTime}ã€€ï½œã€€æ„Ÿæ¸¬å™¨è®€å–æ™‚é–“ï¼š${genTime}ã€€ï½œã€€ğŸ”„ ä¸‹æ¬¡æ›´æ–°å€’æ•¸ï¼š${m}:${s}`;
}

async function fetchCSV(){
  const res=await fetch(CONFIG.sheetCsvUrl+"&t="+Date.now(),{cache:'no-store'});
  const text=await res.text();
  const lines=text.trim().split(/\r?\n/).map(l=>l.split(',').map(v=>v.replace(/^"|"$/g,'').trim()));
  const cols=lines[0].map(c=>c.replace(/^\uFEFF/,'').trim());
  const rows=lines.slice(1);
  return {cols,rows};
}

function getLastValid(rows){
  for(let i=rows.length-1;i>=0;i--) if(rows[i].some(v=>v!=="")) return rows[i];
  return null;
}

async function refreshSheet(depth="Surface"){
  try{
    const {cols, rows} = await fetchCSV();
    const last = getLastValid(rows);
    if(!last) return;

    const timeIdx = cols.findIndex(c=>c.toLowerCase().includes("time"));
    genTime = timeIdx>=0 ? last[timeIdx] : "â€”";
    updateFooter();

    const idx={}; cols.forEach((c,i)=>idx[c.toLowerCase()]=i);

    document.getElementById("envTemp").textContent = roundInt(last[idx["teagarden_air_temp"]]);
    document.getElementById("envHumi").textContent = roundInt(last[idx["teagarden_air_humidity"]]);

    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    for(let s=1;s<=CONFIG.stationCount;s++){
      const p=`station${s}_${depth.toLowerCase()}`;

      const soilTemp = roundInt(last[idx[`${p}_soiltemp`]]);
      const soilMoist = roundInt(last[idx[`${p}_soilmoisture`]]);
      const nitrogen = roundInt(last[idx[`${p}_nitrogen`]]);
      const phosphorus = roundInt(last[idx[`${p}_phosphorus`]]);
      const potassium = roundInt(last[idx[`${p}_potassium`]]);

      // é€šçŸ¥åˆ¤æ–·
      checkMoisture(s, soilMoist);
      checkNPK(s, nitrogen, phosphorus, potassium);
      checkSoilTemp(s, soilTemp);

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>ç¬¬${s}ç«™</td>
        <td class="${colorClass('temp', soilTemp)}">${soilTemp}</td>
        <td class="${colorClass('moist', soilMoist)}">${soilMoist}</td>
        <td class="${colorClass('n', nitrogen)}">${nitrogen}</td>
        <td class="${colorClass('p', phosphorus)}">${phosphorus}</td>
        <td class="${colorClass('k', potassium)}">${potassium}</td>
      `;
      tbody.appendChild(tr);
    }

  }catch(e){ console.warn("CSV éŒ¯èª¤ï¼š",e); }
}


/* ================================ */
/*      ç‘æˆæ™ºæ…§èŒ¶åœ’ AI é€šçŸ¥       */
/* ================================ */

let notified = {
  moisture: {},
  npk: {},
  temp: {},
  weather: false,
  offline: false
};

/* â­ åªç”¨ Telegram é€šçŸ¥ */
function alertTea(title, msg) {
  sendTelegram(title, msg);
  console.log("[Telegram é€šçŸ¥]", title, msg);
}


/* 1. å«æ°´ç‡ */
function checkMoisture(station, value) {
  if (value < 20 && !notified.moisture[station]) {
    alertTea("åœŸå£¤å«æ°´ç‡åä½", `ç¬¬ ${station} ç«™å«æ°´ç‡åƒ… ${value}%`);
    notified.moisture[station] = true;
  }
}

/* 2. NPK */
function checkNPK(station, n, p, k) {
  if (n === 0 && !notified.npk[station+"_n"]) {
    alertTea("N æ°®å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ N=0`);
    notified.npk[station+"_n"] = true;
  }
  if (p === 0 && !notified.npk[station+"_p"]) {
    alertTea("P ç£·å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ P=0`);
    notified.npk[station+"_p"] = true;
  }
  if (k === 0 && !notified.npk[station+"_k"]) {
    alertTea("K é‰€å€¼ç•°å¸¸", `ç¬¬ ${station} ç«™ K=0`);
    notified.npk[station+"_k"] = true;
  }
}

/* 3. åœŸå£¤æº«åº¦ */
function checkSoilTemp(station, value) {
  if (value > 35 && !notified.temp[station]) {
    alertTea("åœŸå£¤æº«åº¦éé«˜", `ç¬¬ ${station} ç«™ ${value}Â°C`);
    notified.temp[station] = true;
  }
  if (value < 10 && !notified.temp[station+"_low"]) {
    alertTea("åœŸå£¤éå†·", `ç¬¬ ${station} ç«™ ${value}Â°C`);
    notified.temp[station+"_low"] = true;
  }
}


/* ============= å¤©æ°£ API ============= */
async function refreshWeather(){
  try{
    const url=`https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${CONFIG.cwaAuth}&format=JSON&StationId=${CONFIG.cwaStation}`;
    const res=await fetch(url);
    const js=await res.json();
    const st=js.records?.Station?.[0];
    const w=st?.WeatherElement||{};

    document.getElementById("weatherDesc").textContent=w.Weather||"â€”";
    document.getElementById("weatherTemp").textContent=roundInt(w.AirTemperature);
    document.getElementById("weatherHumi").textContent=roundInt(w.RelativeHumidity);
    document.getElementById("rainfall").textContent=roundInt(w.Now?.Precipitation);

    weatherTime = (st?.ObsTime?.DateTime||"").replace("T"," ").slice(0,19) || "â€”";
    updateFooter();

  }catch(e){ console.warn("æ°£è±¡éŒ¯èª¤:", e); }
}


/* ============= æŒ‰éˆ•/å€’æ•¸/æ™‚é˜ ============= */
document.querySelectorAll(".depth-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".depth-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    refreshSheet(btn.getAttribute("data-depth"));
  });
});

document.getElementById("btnFullscreen").onclick=()=>document.documentElement.requestFullscreen?.();

/* æ™‚é˜ */
(function clockTick(){
  document.getElementById("mainClock").textContent=nowStr();
  document.getElementById("dateBox").textContent=dateStr();
  requestAnimationFrame(()=>setTimeout(clockTick,250));
})();

/* å€’æ•¸åˆ·æ–° */
setInterval(()=>{
  remainingSec--;
  if(remainingSec<=0){
    location.replace(location.href.split("?")[0]+"?t="+Date.now());
    return;
  }
  updateFooter();
},1000);


/* åˆå§‹åŒ– */
refreshSheet();
refreshWeather();
</script>
